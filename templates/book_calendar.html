{% extends "base.html" %}

{% block title %}ì‹œê°„ ì„ íƒ - {{ link_name }}{% endblock %}

{% block content %}
<div class="container">
  <h2 class="text-center mb-3">ğŸ“… {{ link_name }}</h2>

  <!-- ğŸ†• ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸ -->
  <div class="alert alert-warning text-center mb-4" id="timer-alert">
    <strong>â° ë‚¨ì€ ì‹œê°„: <span id="countdown">ê³„ì‚° ì¤‘...</span></strong>
  </div>

  <p class="text-center text-muted mb-4">
    <strong>{{ booking.name }}</strong>ë‹˜,<br>
    ì›í•˜ì‹œëŠ” ì‹œê°„ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
  </p>

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <!-- ìº˜ë¦°ë” UI -->
  <div class="card p-4 shadow-sm border-0 coffee-card mb-4">
    <div id="calendar-container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <button id="prev-month" class="btn btn-outline-secondary">â—€ ì´ì „</button>
        <h5 id="current-month" class="mb-0"></h5>
        <button id="next-month" class="btn btn-outline-secondary">ë‹¤ìŒ â–¶</button>
      </div>
      <div id="calendar-grid"></div>
    </div>

    <!-- ì„ íƒëœ ì‹œê°„ëŒ€ í‘œì‹œ -->
    <div id="selected-slots" class="mt-4">
      <h6>ì„ íƒëœ ì‹œê°„:</h6>
      <div id="slot-list" class="text-muted">ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
    </div>

    <!-- ì˜ˆì•½ ì œì¶œ -->
    <form method="post" id="booking-form">
      <input type="hidden" name="selected_slot" id="selected-slot-input">
      <button type="submit" class="btn coffee-btn w-100 mt-3" disabled id="submit-btn">
        ì˜ˆì•½ í™•ì •
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block script %}
<style>
  body {
    background-color: #f3ede7;
    font-family: 'Inter', sans-serif;
    color: #5e4634;
  }

  .coffee-card {
    background-color: #fffdfc;
    border-radius: 1rem;
    max-width: 800px;
    margin: 0 auto;
  }

  .coffee-btn {
    background-color: #6b4c3b;
    color: white;
    border: 1px solid #6b4c3b;
    transition: all 0.2s ease-in-out;
  }

  .coffee-btn:hover:not(:disabled) {
    background-color: #f3ede7;
    color: #6b4c3b;
    border: 1px solid #6b4c3b;
  }

  .coffee-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  #calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 5px;
  }

  .calendar-day {
    padding: 10px;
    text-align: center;
    border: 1px solid #ddd;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .calendar-day.header {
    font-weight: bold;
    background-color: #6b4c3b;
    color: white;
    cursor: default;
  }

  .calendar-day.disabled {
    background-color: #f5f5f5;
    color: #ccc;
    cursor: not-allowed;
  }

  .calendar-day.available:hover {
    background-color: #c5a990;
    color: white;
  }

  .calendar-day.selected {
    background-color: #6b4c3b;
    color: white;
  }

  .time-slot {
    display: inline-block;
    padding: 8px 15px;
    margin: 5px;
    border: 1px solid #6b4c3b;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .time-slot:hover {
    background-color: #c5a990;
    color: white;
  }

  .time-slot.selected {
    background-color: #6b4c3b;
    color: white;
  }

  .time-slot.busy {
    background-color: #f5f5f5;
    color: #ccc;
    cursor: not-allowed;
    border-color: #ddd;
  }

  #timer-alert.expired {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
  }
</style>

<script>
// ğŸ†• ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸
const expiresAt = new Date("{{ expires_at }}");

function updateCountdown() {
  const now = new Date();
  const diff = expiresAt - now;

  if (diff <= 0) {
    document.getElementById('countdown').textContent = 'ë§Œë£Œë¨';
    document.getElementById('timer-alert').classList.add('expired');
    document.getElementById('submit-btn').disabled = true;

    // 3ì´ˆ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    setTimeout(() => {
      window.location.href = '/book/{{ token }}';
    }, 3000);
    return;
  }

  const minutes = Math.floor(diff / 60000);
  const seconds = Math.floor((diff % 60000) / 1000);

  document.getElementById('countdown').textContent =
    `${minutes}ë¶„ ${seconds}ì´ˆ`;

  // 1ë¶„ ë¯¸ë§Œ ì‹œ ë¹¨ê°„ìƒ‰
  if (minutes < 1) {
    document.getElementById('timer-alert').classList.add('expired');
  }
}

updateCountdown();
setInterval(updateCountdown, 1000);

// ìº˜ë¦°ë” ë¡œì§
let currentDate = new Date();
let selectedSlot = null;

// ìº˜ë¦°ë” ë Œë”ë§
function renderCalendar() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  document.getElementById('current-month').textContent =
    `${year}ë…„ ${month + 1}ì›”`;

  const firstDay = new Date(year, month, 1).getDay();
  const lastDate = new Date(year, month + 1, 0).getDate();

  const grid = document.getElementById('calendar-grid');
  grid.innerHTML = '';

  // ìš”ì¼ í—¤ë”
  ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(day => {
    const header = document.createElement('div');
    header.className = 'calendar-day header';
    header.textContent = day;
    grid.appendChild(header);
  });

  // ë¹ˆ ì¹¸
  for (let i = 0; i < firstDay; i++) {
    const empty = document.createElement('div');
    empty.className = 'calendar-day disabled';
    grid.appendChild(empty);
  }

  // ë‚ ì§œ
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  for (let date = 1; date <= lastDate; date++) {
    const dayDiv = document.createElement('div');
    const currentDay = new Date(year, month, date);

    if (currentDay < today) {
      dayDiv.className = 'calendar-day disabled';
    } else {
      dayDiv.className = 'calendar-day available';
      dayDiv.onclick = () => showTimeSlots(year, month, date);
    }

    dayDiv.textContent = date;
    grid.appendChild(dayDiv);
  }
}

// ì‹œê°„ëŒ€ ì„ íƒ í‘œì‹œ
function showTimeSlots(year, month, date) {
  const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;

  // êµ¬ê¸€ ìº˜ë¦°ë”ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ì‹œê°„ ì¡°íšŒ (í–¥í›„ êµ¬í˜„)
  // ì§€ê¸ˆì€ 10:00-18:00 30ë¶„ ë‹¨ìœ„ë¡œ í‘œì‹œ
  const slots = [];
  for (let hour = 10; hour < 18; hour++) {
    slots.push(`${String(hour).padStart(2, '0')}:00`);
    slots.push(`${String(hour).padStart(2, '0')}:30`);
  }

  const slotList = document.getElementById('slot-list');
  slotList.innerHTML = `<strong>${dateStr}</strong><br>`;

  slots.forEach(time => {
    const slotDiv = document.createElement('span');
    slotDiv.className = 'time-slot';
    slotDiv.textContent = time;
    slotDiv.onclick = () => selectSlot(`${dateStr} ${time}`);
    slotList.appendChild(slotDiv);
  });
}

// ìŠ¬ë¡¯ ì„ íƒ
function selectSlot(slot) {
  selectedSlot = slot;

  // ëª¨ë“  ìŠ¬ë¡¯ì˜ ì„ íƒ í•´ì œ
  document.querySelectorAll('.time-slot').forEach(el => {
    el.classList.remove('selected');
  });

  // í˜„ì¬ ìŠ¬ë¡¯ ì„ íƒ
  event.target.classList.add('selected');

  // hidden input ì—…ë°ì´íŠ¸
  document.getElementById('selected-slot-input').value = slot;

  // ì œì¶œ ë²„íŠ¼ í™œì„±í™”
  document.getElementById('submit-btn').disabled = false;
}

// ì´ì „/ë‹¤ìŒ ë‹¬ ë²„íŠ¼
document.getElementById('prev-month').onclick = () => {
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderCalendar();
};

document.getElementById('next-month').onclick = () => {
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderCalendar();
};

// ì´ˆê¸° ë Œë”ë§
renderCalendar();
</script>
{% endblock %}
