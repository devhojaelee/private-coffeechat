{% extends "base.html" %}

{% block title %}ê´€ë¦¬ì í˜ì´ì§€ | ì»¤í”¼ì±—{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>ğŸ”§ ê´€ë¦¬ì í˜ì´ì§€</h2>
  <form method="post" action="{{ url_for('admin_logout') }}" onsubmit="return confirmLogout();">
    <button type="submit" class="btn btn-outline-danger btn-sm">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </form>
</div>

<!-- ğŸ†• ì˜ˆì•½ ë§í¬ ê´€ë¦¬ ì„¹ì…˜ -->
<h3 class="mb-3">ğŸ”— ì˜ˆì•½ ë§í¬ ê´€ë¦¬</h3>

<!-- ìƒˆ ë§í¬ ìƒì„± í¼ -->
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">ìƒˆ ì˜ˆì•½ ë§í¬ ìƒì„± (ê°œì¸ë³„ 1íšŒìš©)</h5>
    <p class="text-muted small">
      ë§í¬ëŠ” ê´€ë¦¬ìê°€ ì§ì ‘ ê³µìœ í•˜ë©°, ë¯¸í™•ì¸ ì‹œ 7ì¼ê°„ ìœ íš¨í•©ë‹ˆë‹¤.<br>
      ë§í¬ ì²« í´ë¦­ ì‹œ 30ë¶„ íƒ€ì´ë¨¸ê°€ ì‹œì‘ë˜ë©°, ì˜ˆì•½ ì™„ë£Œ ì‹œ ìë™ ë§Œë£Œë©ë‹ˆë‹¤.
    </p>
    <form method="post">
      <div class="row g-3 align-items-end">
        <div class="col-md-8">
          <label class="form-label">ë§í¬ ì´ë¦„/ì„¤ëª…</label>
          <input type="text" name="link_name" class="form-control" placeholder="í™ê¸¸ë™ë‹˜ ì»¤í”¼ì±—" required>
        </div>
        <div class="col-md-4">
          <button type="submit" name="create_booking_link" value="1" class="btn btn-primary w-100">
            â• ë§í¬ ìƒì„±
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ê¸°ì¡´ ë§í¬ ëª©ë¡ -->
{% if booking_links %}
<div class="table-responsive mb-5">
  <table class="table table-hover table-sm">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>ë§í¬ ì´ë¦„</th>
        <th>URL</th>
        <th>ìƒì„±ì¼</th>
        <th>ì²« ì ‘ì†</th>
        <th>ë§Œë£Œì‹œê°</th>
        <th>ìƒíƒœ</th>
        <th>ê´€ë¦¬</th>
      </tr>
    </thead>
    <tbody>
      {% for link in booking_links %}
      <tr>
        <td>{{ link[0] }}</td>
        <td>{{ link[2] }}</td>
        <td>
          <code class="small">{{ host_url }}book/{{ link[1] }}</code>
          <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('{{ host_url }}book/{{ link[1] }}')">ğŸ“‹</button>
        </td>
        <td class="small">{{ link[3][:16] if link[3] else '-' }}</td>
        <td class="small">{{ link[4][:16] if link[4] else 'ë¯¸ì ‘ì†' }}</td>
        <td class="small">{{ link[5][:16] if link[5] else 'ë¯¸ì„¤ì •' }}</td>
        <td>
          {% if link[6] == 1 %}
            <span class="badge bg-success">ì‚¬ìš©ì™„ë£Œ</span>
          {% elif link[7] == 0 %}
            <span class="badge bg-secondary">ë¹„í™œì„±</span>
          {% elif link[5] and link[5] < now %}
            <span class="badge bg-danger">ë§Œë£Œ</span>
          {% elif link[4] %}
            <span class="badge bg-warning">ì§„í–‰ì¤‘</span>
          {% else %}
            <span class="badge bg-info">ë¯¸ì‚¬ìš©</span>
          {% endif %}
        </td>
        <td>
          <form method="post" style="display: inline;">
            {% if link[7] == 1 and link[6] == 0 %}
              <button type="submit" name="deactivate_link_id" value="{{ link[0] }}" class="btn btn-sm btn-warning btn-xs">ë¹„í™œì„±í™”</button>
            {% elif link[7] == 0 %}
              <button type="submit" name="activate_link_id" value="{{ link[0] }}" class="btn btn-sm btn-success btn-xs">í™œì„±í™”</button>
            {% endif %}
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p class="text-muted">ìƒì„±ëœ ì˜ˆì•½ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

<hr class="my-5">

<!-- ğŸ†• ì˜ˆì•½ ëª©ë¡ ì„¹ì…˜ -->
<h3 class="mb-3">ğŸ“… ì˜ˆì•½ ëª©ë¡ (ì‹ ê·œ ì‹œìŠ¤í…œ)</h3>
{% if bookings %}
<div class="table-responsive mb-5">
  <table class="table table-hover">
    <thead class="table-primary">
      <tr>
        <th>ID</th>
        <th>ì´ë¦„</th>
        <th>ì´ë©”ì¼</th>
        <th>ì „í™”ë²ˆí˜¸</th>
        <th>ìš©ê±´</th>
        <th>ì„ íƒ ì‹œê°„</th>
        <th>ë§í¬</th>
        <th>ìƒíƒœ</th>
        <th>ìŠ¹ì¸</th>
      </tr>
    </thead>
    <tbody>
      {% for booking in bookings %}
      <tr>
        <td>{{ booking[0] }}</td>
        <td>{{ booking[1] }}</td>
        <td>{{ booking[2] }}</td>
        <td>{{ booking[3] }}</td>
        <td>{{ booking[4][:30] }}...</td>
        <td><strong>{{ booking[5] }}</strong></td>
        <td><span class="badge bg-info">{{ booking[9] }}</span></td>
        <td>
          {% if booking[6] == 'confirmed' %}
            <span class="badge bg-success">í™•ì •</span>
          {% elif booking[6] == 'cancelled' %}
            <span class="badge bg-danger">ì·¨ì†Œë¨</span>
          {% else %}
            <span class="badge bg-secondary">ëŒ€ê¸° ì¤‘</span>
          {% endif %}
        </td>
        <td>
          {% if booking[6] == 'pending' %}
            <form method="post" style="display: inline;">
              <button type="submit" name="approve_booking_id" value="{{ booking[0] }}" class="btn btn-sm btn-success">ìŠ¹ì¸</button>
            </form>
          {% elif booking[6] == 'confirmed' and booking[7] %}
            <a href="{{ booking[7] }}" target="_blank" class="btn btn-sm btn-primary">Meet ë§í¬</a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p class="text-muted">ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

<hr class="my-5">

<!-- Waitlist ì„¹ì…˜ -->
<h3 class="mb-3">ğŸ“ ëŒ€ê¸° ëª…ë‹¨</h3>
{% if waitlist %}
{% for w in waitlist %}
<div class="waitlist-card">
  <table class="table table-bordered text-center mb-2">
    <thead class="table-info">
      <tr>
        <th>ID</th><th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>ì „í™”ë²ˆí˜¸</th><th>ìƒíƒœ</th><th>ë“±ë¡ì¼</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ w[0] }}</td>
        <td>{{ w[1] }}</td>
        <td>{{ w[2] }}</td>
        <td>{{ w[3] }}</td>
        <td>
          {% if w[5] == 'approved' %}
            <span class="badge bg-success">ìŠ¹ì¸ë¨</span>
          {% elif w[5] == 'rejected' %}
            <span class="badge bg-danger">ê±°ì ˆë¨</span>
          {% else %}
            <span class="badge bg-secondary">ëŒ€ê¸° ì¤‘</span>
          {% endif %}
        </td>
        <td>{{ w[6] }}</td>
      </tr>
    </tbody>
  </table>

  <!-- ìš©ê±´ í‘œì‹œ -->
  <table class="table table-sm table-bordered mb-2">
    <thead class="table-light">
      <tr><th>ëŒ€í™”í•˜ê³  ì‹¶ì€ ì£¼ì œ</th></tr>
    </thead>
    <tbody>
      <tr><td>{{ w[4] }}</td></tr>
    </tbody>
  </table>

  {% if w[5] == 'pending' %}
  <div class="action-buttons">
    <form method="post" onsubmit="return confirm('ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ë©”ì¼ë¡œ ìº˜ë¦°ë” ë§í¬ê°€ ì „ì†¡ë©ë‹ˆë‹¤.');">
      <input type="hidden" name="approve_waitlist_id" value="{{ w[0] }}">
      <button type="submit" class="btn btn-sm btn-success">ìŠ¹ì¸</button>
    </form>
    <form method="post" onsubmit="return confirm('ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
      <input type="hidden" name="reject_waitlist_id" value="{{ w[0] }}">
      <button type="submit" class="btn btn-sm btn-warning">ê±°ì ˆ</button>
    </form>
  </div>
  {% endif %}
</div>
{% endfor %}
{% else %}
<p class="text-muted">ëŒ€ê¸° ì¤‘ì¸ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

<hr class="my-5">

<!-- ì˜ˆì•½ ì‹ ì²­ ëª©ë¡ ì„¹ì…˜ -->
<h3 class="mb-3">ğŸ“‹ ì˜ˆì•½ ì‹ ì²­ ëª©ë¡</h3>

{% for r in reservations %}
<div class="reservation-card">
  <!-- ê¸°ë³¸ ì •ë³´ í…Œì´ë¸” (PCìš©) -->
  <table class="table table-bordered text-center mb-2 align-middle d-none d-sm-table">
    <thead class="table-dark">
      <tr>
        <th>ID</th><th>ì´ë¦„</th><th>ì´ë©”ì¼</th><th>ì „í™”ë²ˆí˜¸</th><th>ìƒíƒœ</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ r[0] }}</td>
        <td class="text-nowrap">{{ r[2] }}</td>
        <td class="text-nowrap">{{ r[3] }}</td>
        <td class="text-nowrap">{{ r[4] }}</td>
        <td class="text-nowrap">
          {% if r[9] == "ìŠ¹ì¸ë¨" %}
            <span class="badge bg-success">ìŠ¹ì¸ë¨<br><small>{{ r[8] }}</small></span>
          {% elif r[9] == "ê±°ì ˆë¨" %}
            <span class="badge bg-danger">ê±°ì ˆë¨</span>
          {% else %}
            <span class="badge bg-secondary">ëŒ€ê¸° ì¤‘</span>
          {% endif %}
        </td>
      </tr>
    </tbody>
  </table>

  <!-- ëª¨ë°”ì¼ìš© ê¸°ë³¸ ì •ë³´ ë¶„í•  í…Œì´ë¸” -->
  <table class="table table-bordered text-center mb-2 align-middle d-sm-none">
    <thead class="table-dark">
      <tr><th>ID</th><th>ì´ë¦„</th></tr>
    </thead>
    <tbody>
      <tr>
        <td>{{ r[0] }}</td>
        <td class="text-nowrap">{{ r[2] }}</td>
      </tr>
    </tbody>
  </table>
  <table class="table table-bordered text-center mb-2 align-middle d-sm-none">
    <thead class="table-dark">
      <tr><th>ì´ë©”ì¼</th><th>ì „í™”ë²ˆí˜¸</th></tr>
    </thead>
    <tbody>
      <tr>
        <td class="text-nowrap">{{ r[3] }}</td>
        <td class="text-nowrap">{{ r[4] }}</td>
      </tr>
    </tbody>
  </table>
  <table class="table table-bordered text-center mb-2 align-middle d-sm-none">
    <thead class="table-dark">
      <tr><th>ìƒíƒœ</th></tr>
    </thead>
    <tbody>
      <tr>
        <td class="text-nowrap">
          {% if r[9] == "ìŠ¹ì¸ë¨" %}
            <span class="badge bg-success">ìŠ¹ì¸ë¨<br><small>{{ r[8] }}</small></span>
          {% elif r[9] == "ê±°ì ˆë¨" %}
            <span class="badge bg-danger">ê±°ì ˆë¨</span>
          {% else %}
            <span class="badge bg-secondary">ëŒ€ê¸° ì¤‘</span>
          {% endif %}
        </td>
      </tr>
    </tbody>
  </table>

  <!-- ì˜ˆì•½ ì‹œê°„ í…Œì´ë¸” -->
  <table class="table table-sm table-bordered mb-2">
    <thead class="table-light">
      <tr><th>ì˜ˆì•½ ì‹œê°„</th></tr>
    </thead>
    <tbody>
      {% for slot in r[6] %}
      <tr><td class="text-nowrap">{{ loop.index }}ï¸âƒ£ {{ slot }}</td></tr>
      {% endfor %}
    </tbody>
  </table>

  {% set start_time = r[6]|sort|first %}
  {% set end_time = r[6]|sort|last %}
  {% set start_hour = start_time[11:13]|int %}
  {% set start_minute = start_time[14:16]|int %}
  {% set end_hour = end_time[11:13]|int %}
  {% set end_minute = end_time[14:16]|int + 30 %}
  {% if end_minute >= 60 %}
    {% set end_hour = end_hour + 1 %}
    {% set end_minute = end_minute - 60 %}
  {% endif %}
  {% set slot_count = r[6]|length %}
  {% set total_minutes = slot_count * 30 %}
  {% set total_hours = total_minutes // 60 %}
  {% set remain_minutes = total_minutes % 60 %}

  <p class="text-end text-muted small">
    {{ '%02d:%02d' % (start_hour, start_minute) }} ~ {{ '%02d:%02d' % (end_hour, end_minute) }} (ì´
    {% if total_hours > 0 %}{{ total_hours }}ì‹œê°„ {% endif %}
    {% if remain_minutes > 0 or total_hours == 0 %}{{ remain_minutes }}ë¶„{% endif %})
  </p>

  <!-- ëŒ€í™”í•˜ê³  ì‹¶ì€ ì£¼ì œ í…Œì´ë¸” -->
  <table class="table table-sm table-bordered mb-3">
    <thead class="table-light">
      <tr><th>ëŒ€í™”í•˜ê³  ì‹¶ì€ ì£¼ì œ</th></tr>
    </thead>
    <tbody>
      <tr><td>{{ r[5] }}</td></tr>
    </tbody>
  </table>

  <!-- ê´€ë¦¬ ë° ì‚­ì œ ë²„íŠ¼ -->
  <div class="action-buttons">
    {% if r[9] != "ìŠ¹ì¸ë¨" %}
    <form method="post" onsubmit="return confirm('ì •ë§ë¡œ ì´ ì˜ˆì•½ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ? Meet ë§í¬ê°€ ìƒì„±ë˜ê³  ì´ë©”ì¼ì´ ë°œì†¡ë©ë‹ˆë‹¤.');">
      <input type="hidden" name="approve_id" value="{{ r[0] }}">
      <button type="submit" class="btn btn-sm btn-success">Meet ë§í¬ ìƒì„± ë° ìŠ¹ì¸</button>
    </form>
    {% endif %}
    <form method="post" onsubmit="return confirm('ì •ë§ë¡œ ì´ ì˜ˆì•½ì„ ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
      <input type="hidden" name="reject_id" value="{{ r[0] }}">
      <button type="submit" class="btn btn-sm btn-warning">ê±°ì ˆ</button>
    </form>
    <form method="post" onsubmit="return confirm('ì •ë§ë¡œ ì´ ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì‚­ì œí•˜ë©´ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');">
      <input type="hidden" name="remove_id" value="{{ r[0] }}">
      <button type="submit" class="btn btn-sm btn-danger">ì‚­ì œ</button>
    </form>
  </div>
</div>
{% endfor %}

<a href="/" class="btn btn-secondary mt-4">í™ˆìœ¼ë¡œ</a>
{% endblock %}

{% block script %}
<style>
  .waitlist-card {
    border: 2px solid #cfe2ff;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    background-color: #f8f9fa;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .reservation-card {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    background-color: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .action-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
  }
  @media (max-width: 576px) {
    .table th, .table td {
      font-size: 0.85rem;
      padding: 0.3rem;
    }
    .reservation-card, .waitlist-card {
      padding: 1rem;
    }
  }
</style>

<script>
function confirmLogout() {
    return confirm("ì •ë§ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
  }

  // ğŸ†• í´ë¦½ë³´ë“œ ë³µì‚¬ í•¨ìˆ˜
  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
      alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: ' + text);
    }, function(err) {
      alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err);
    });
  }

  // âœ… 10ë¶„ í›„ ìë™ ë¡œê·¸ì•„ì›ƒ (indexë¡œ ì´ë™)
  setTimeout(function () {
    alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì–´ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.");
    window.location.href = "{{ url_for('home') }}";
  }, 600000); // 600,000ms = 10ë¶„
</script>
{% endblock %}