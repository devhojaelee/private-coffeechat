{% extends "base.html" %}

{% block title %}ê´€ë¦¬ì í˜ì´ì§€ | ì»¤í”¼ì±—{% endblock %}

{% block content %}
<style>
  body {
    background-color: #f3ede7;
    font-family: 'Inter', sans-serif;
  }

  .admin-header {
    background: linear-gradient(135deg, #6b4c3b 0%, #4a3f35 100%);
    color: white;
    padding: 2rem;
    border-radius: 1rem;
    margin-bottom: 2rem;
  }

  .admin-header h1 {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 600;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: white;
    padding: 1rem;
    border-radius: 0.75rem;
    border: 1px solid #e9ecef;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 0.5rem;
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .stat-card .icon {
    font-size: 2rem;
  }

  .stat-card .value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #6b4c3b;
    line-height: 1;
  }

  .stat-card .label {
    color: #6c757d;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .section {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid #e9ecef;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f3ede7;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #4a3f35;
    margin: 0;
  }

  .table-modern {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .table-modern thead th {
    background-color: #f8f9fa;
    color: #6b4c3b;
    font-weight: 600;
    padding: 1rem;
    text-align: center;
    border-bottom: 2px solid #e9ecef;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .table-modern tbody tr {
    border-bottom: 1px solid #f3ede7;
    transition: background-color 0.2s;
  }

  .table-modern tbody tr:hover {
    background-color: #f8f9fa;
  }

  .table-modern tbody td {
    padding: 1rem;
    vertical-align: middle;
    white-space: nowrap;
    text-align: center;
  }

  .table-modern tbody td.wrap {
    white-space: normal;
    max-width: 200px;
  }

  .table-modern tbody td.email-cell {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .table-modern tbody td.time-cell {
    max-width: 120px;
    font-size: 0.8rem;
  }

  .table-modern tbody td.remaining-cell {
    max-width: 100px;
    font-size: 0.8rem;
  }

  .status-badge {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-pending {
    background-color: #fff3cd;
    color: #856404;
  }

  .status-confirmed {
    background-color: #d4edda;
    color: #155724;
  }

  .status-cancelled {
    background-color: #f8d7da;
    color: #721c24;
  }

  .btn-modern {
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    border: none;
    font-weight: 500;
    font-size: 0.875rem;
    transition: all 0.2s;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 32px;
  }

  .btn-modern.btn-sm {
    padding: 0.35rem 0.6rem;
    font-size: 0.75rem;
    min-height: 28px;
  }

  .btn-approve {
    background-color: #6b4c3b;
    color: white;
  }

  .btn-approve:hover {
    background-color: #4a3f35;
    transform: translateY(-1px);
  }

  .btn-reject {
    background-color: #dc3545;
    color: white;
  }

  .btn-reject:hover {
    background-color: #c82333;
  }

  .btn-create {
    background-color: #6b4c3b;
    color: white;
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    border: none;
    font-weight: 500;
    font-size: 0.875rem;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 32px;
  }

  .btn-create:hover {
    background-color: #4a3f35;
    transform: translateY(-1px);
  }

  .btn-delete {
    background-color: #6c757d;
    color: white;
  }

  .btn-delete:hover {
    background-color: #5a6268;
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
  }

  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .link-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .link-active {
    background-color: #d4edda;
    color: #155724;
  }

  .link-used {
    background-color: #f8d7da;
    color: #721c24;
  }

  .link-expired {
    background-color: #e2e3e5;
    color: #6c757d;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
  }

  .pagination button {
    padding: 0.5rem 0.75rem;
    border: 1px solid #e9ecef;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.875rem;
  }

  .pagination button:hover:not(:disabled) {
    background: #f8f9fa;
    border-color: #6b4c3b;
  }

  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pagination button.active {
    background: #6b4c3b;
    color: white;
    border-color: #6b4c3b;
  }

  .pagination .page-info {
    color: #6c757d;
    font-size: 0.875rem;
    padding: 0 1rem;
  }

  @media (max-width: 768px) {
    /* í—¤ë” */
    .admin-header {
      padding: 1rem;
    }

    .admin-header h1 {
      font-size: 1.25rem;
    }

    /* í†µê³„ ì¹´ë“œ 2ì—´ */
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    .stat-card {
      padding: 0.75rem;
    }

    .stat-card .icon {
      font-size: 1.5rem;
    }

    .stat-card .value {
      font-size: 1.5rem;
    }

    /* ì„¹ì…˜ */
    .section {
      padding: 1rem;
      border-radius: 0.75rem;
    }

    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .section-title {
      font-size: 1.1rem;
    }

    /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ */
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table-modern {
      font-size: 0.8rem;
      min-width: 600px;
    }

    .table-modern thead th,
    .table-modern tbody td {
      padding: 0.5rem 0.25rem;
      white-space: nowrap;
    }

    /* ë²„íŠ¼ */
    .btn-sm {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }

    /* ì›” ë„¤ë¹„ê²Œì´ì…˜ */
    .month-nav {
      flex-direction: column;
      gap: 0.5rem;
    }

    /* í•„í„° í¼ */
    .filter-form {
      flex-direction: column;
      align-items: stretch;
    }

    .filter-form .form-control,
    .filter-form .form-select {
      width: 100%;
    }
  }

  @media (max-width: 768px) {
    /* ëª¨ë°”ì¼ì—ì„œ í†µê³„ ì¹´ë“œë¥¼ ë§¨ ë°‘ìœ¼ë¡œ ì´ë™ */
    #admin-content {
      display: flex;
      flex-direction: column;
    }

    #stats-section {
      order: 999;
    }
  }

  @media (max-width: 480px) {
    /* ì„¹ì…˜ íŒ¨ë”© ì¶•ì†Œ */
    .section {
      padding: 0.75rem;
    }

    /* í…Œì´ë¸” ë” ì¶•ì†Œ */
    .table-modern {
      font-size: 0.75rem;
    }

    .table-modern thead th,
    .table-modern tbody td {
      padding: 0.4rem 0.2rem;
    }
  }
</style>

<!-- Header -->
<div class="admin-header">
  <div class="d-flex justify-content-between align-items-center">
    <h1>â˜• ì»¤í”¼ì±— ê´€ë¦¬ì</h1>
    <form method="post" action="{{ url_for('admin_logout') }}" class="m-0">
      <button type="submit" class="btn btn-outline-light btn-sm">ë¡œê·¸ì•„ì›ƒ</button>
    </form>
  </div>
</div>

<div id="admin-content">
  <!-- Stats Section -->
  <div id="stats-section">
    <!-- Stats Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h2 style="font-size: 1.25rem; font-weight: 600; color: #4a3f35; margin: 0;">ğŸ“Š í†µê³„</h2>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <button onclick="changeStatsMonth(-1)" class="btn-modern" style="padding: 0.5rem 0.75rem;">
          â—€
        </button>
        <span id="statsMonthLabel" style="font-size: 1rem; font-weight: 600; color: #6b4c3b; min-width: 100px; text-align: center;">
          <!-- JavaScriptë¡œ ì±„ì›Œì§ -->
        </span>
        <button onclick="changeStatsMonth(1)" class="btn-modern" style="padding: 0.5rem 0.75rem;">
          â–¶
        </button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="icon">â³</div>
        <div class="value" id="stat-pending">0</div>
        <div class="label">ìŠ¹ì¸ ëŒ€ê¸°</div>
      </div>
      <div class="stat-card">
        <div class="icon">âœ…</div>
        <div class="value" id="stat-confirmed">0</div>
        <div class="label">ìŠ¹ì¸ ì™„ë£Œ</div>
      </div>
      <div class="stat-card">
        <div class="icon">âŒ</div>
        <div class="value" id="stat-cancelled">0</div>
        <div class="label">ì·¨ì†Œí•¨</div>
      </div>
      <div class="stat-card">
        <div class="icon">ğŸ”—</div>
        <div class="value" id="stat-links">0</div>
        <div class="label">ì „ì²´ í™œì„± ë§í¬</div>
      </div>
    </div>
  </div>

<script>
// ë‚ ì§œ ë¬¸ìì—´ ì •ê·œí™” í•¨ìˆ˜
function normalizeDateTime(isoString) {
  if (!isoString) return null;
  let normalized = isoString.trim();
  // 2025-10-16 11:30 -> 2025-10-16T11:30:00
  if (normalized.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/)) {
    normalized = normalized.replace(' ', 'T') + ':00';
  }
  return normalized;
}

// ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜ (ë¨¼ì € ì •ì˜)
function formatDateTime(isoString) {
  if (!isoString) return '-';
  const normalized = normalizeDateTime(isoString);
  const date = new Date(normalized);
  if (isNaN(date.getTime())) return '-';

  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  let hours = date.getHours();
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12 || 12;
  return `${year}-${month}-${day} ${hours}:${minutes} ${ampm}`;
}

// ì§§ì€ ì‹œê°„ í¬ë§· (í…Œì´ë¸”ìš©)
function formatDateTimeShort(isoString) {
  if (!isoString) return '-';
  const normalized = normalizeDateTime(isoString);
  const date = new Date(normalized);
  if (isNaN(date.getTime())) return '-';

  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  let hours = date.getHours();
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12 || 12;
  return `${month}/${day} ${hours}:${minutes}${ampm}`;
}

// ë‚¨ì€ ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
function getTimeRemaining(isoString) {
  if (!isoString) return '';
  const now = new Date();

  const normalized = normalizeDateTime(isoString);
  const target = new Date(normalized);

  // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ í™•ì¸
  if (isNaN(target.getTime())) {
    console.error('Invalid date:', isoString);
    return '-';
  }

  const diff = target - now;

  if (diff <= 0) return '-';

  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

  if (days > 0) {
    return `${days}ì¼ ${hours}ì‹œê°„`;
  } else if (hours > 0) {
    return `${hours}ì‹œê°„ ${minutes}ë¶„`;
  } else if (minutes > 0) {
    return `${minutes}ë¶„`;
  } else {
    return 'ê³§ ì‹œì‘';
  }
}

// ì „ì²´ ì˜ˆì•½ ë°ì´í„° (ì„œë²„ì—ì„œ ì „ë‹¬)
const allBookings = {{ bookings|tojson }};
const allLinks = {{ booking_links|tojson }};
let currentStatsMonth = new Date();

function updateStats() {
  const year = currentStatsMonth.getFullYear();
  const month = currentStatsMonth.getMonth() + 1;

  // ì›” ë¼ë²¨ ì—…ë°ì´íŠ¸
  document.getElementById('statsMonthLabel').textContent = `${year}ë…„ ${month}ì›”`;

  // í•´ë‹¹ ì›”ì˜ ì˜ˆì•½ë§Œ í•„í„°ë§
  const monthBookings = allBookings.filter(booking => {
    if (!booking[5]) return false; // selected_slotì´ ì—†ìœ¼ë©´ ì œì™¸
    const bookingDate = new Date(booking[5]);
    return bookingDate.getFullYear() === year && bookingDate.getMonth() + 1 === month;
  });

  // í†µê³„ ì—…ë°ì´íŠ¸
  const pending = monthBookings.filter(b => b[6] === 'pending').length;
  const confirmed = monthBookings.filter(b => b[6] === 'confirmed').length;
  const cancelled = monthBookings.filter(b => b[6] === 'cancelled').length;
  // ì „ì²´ í™œì„± ë§í¬ (used=0, active=1) - ì›”ë³„ í•„í„°ë§ ì—†ìŒ
  const activeLinks = allLinks.filter(l => l[6] === 0 && l[7] === 1).length;

  document.getElementById('stat-pending').textContent = pending;
  document.getElementById('stat-confirmed').textContent = confirmed;
  document.getElementById('stat-cancelled').textContent = cancelled;
  document.getElementById('stat-links').textContent = activeLinks;
}

function changeStatsMonth(delta) {
  currentStatsMonth.setMonth(currentStatsMonth.getMonth() + delta);
  updateStats();
}

// ì´ˆê¸° í†µê³„ í‘œì‹œ
updateStats();
</script>

<!-- Pending Bookings (ìš°ì„ ìˆœìœ„ ë†’ìŒ) -->
{% set pending_bookings = bookings|selectattr('6', 'equalto', 'pending')|list %}
{% if pending_bookings %}
<div class="section">
  <div class="section-header">
    <h2 class="section-title">ğŸ”” ìŠ¹ì¸ í•„ìš” ({{ pending_bookings|length }}ê±´)</h2>
  </div>
  <div class="table-responsive">
    <table class="table-modern">
      <thead>
        <tr>
          <th>ì´ë¦„</th>
          <th>ì´ë©”ì¼</th>
          <th>í¬ë§ ì‹œê°„</th>
          <th>ìš©ë¬´</th>
          <th style="width: 200px;">ì‘ì—…</th>
        </tr>
      </thead>
      <tbody>
        {% for booking in pending_bookings %}
        <tr data-booking-id="{{ booking[0] }}">
          <td><strong>{{ booking[1] }}</strong></td>
          <td class="small">{{ booking[2] }}</td>
          <td class="small">{{ booking[5] }}</td>
          <td class="small">{{ booking[4][:30] }}...</td>
          <td>
            <form method="post" class="d-inline" onsubmit="return confirm('ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
              <input type="hidden" name="approve_booking_id" value="{{ booking[0] }}">
              <button type="submit" class="btn-modern btn-approve">âœ“ ìŠ¹ì¸</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- All Bookings -->
<div class="section">
  <div class="section-header">
    <h2 class="section-title">ğŸ“… ì „ì²´ ì˜ˆì•½</h2>
  </div>
  {% if bookings %}
  <div class="table-responsive">
    <table class="table-modern" id="bookingsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>ì´ë¦„</th>
          <th>ì´ë©”ì¼</th>
          <th>ì‹œê°„</th>
          <th>ë‚¨ì€ ì‹œê°„</th>
          <th>ìƒíƒœ</th>
          <th>ì•¡ì…˜</th>
        </tr>
      </thead>
      <tbody id="bookingsTableBody">
        {% for booking in bookings %}
        <tr data-booking-id="{{ booking[0] }}"
            data-booking-row
            data-booking-name="{{ booking[1] }}"
            data-booking-email="{{ booking[2] }}"
            data-booking-phone="{{ booking[3] }}"
            data-booking-purpose="{{ booking[4] }}"
            data-booking-slot="{{ booking[5] }}"
            data-booking-status="{{ booking[6] }}"
            data-booking-meet="{{ booking[7] or '' }}"
            data-booking-created="{{ booking[8] or '' }}"
            data-booking-link="{{ booking[9] or '' }}"
            data-booking-cancel-reason="{{ booking[10] or '' }}">
          <td onclick="showBookingDetailFromRow(this.parentElement)" style="cursor: pointer;">{{ booking[0] }}</td>
          <td onclick="showBookingDetailFromRow(this.parentElement)" style="cursor: pointer;"><strong>{{ booking[1] }}</strong></td>
          <td class="email-cell" onclick="showBookingDetailFromRow(this.parentElement)" style="cursor: pointer;" title="{{ booking[2] }}">{{ booking[2] }}</td>
          <td class="time-cell" onclick="showBookingDetailFromRow(this.parentElement)" style="cursor: pointer;">
            {% if booking[5] %}
            <script>document.write(formatDateTimeShort('{{ booking[5] }}'));</script>
            {% else %}
            -
            {% endif %}
          </td>
          <td class="remaining-cell" onclick="showBookingDetailFromRow(this.parentElement)" style="cursor: pointer; color: #6b4c3b; font-weight: 600;">
            {% if booking[5] %}
            <script>
              const remaining = getTimeRemaining('{{ booking[5] }}');
              if (remaining) document.write(remaining);
              else document.write('-');
            </script>
            {% else %}
            -
            {% endif %}
          </td>
          <td onclick="showBookingDetailFromRow(this.parentElement)" style="cursor: pointer;">
            {% if booking[6] == 'pending' %}
              <span class="status-badge status-pending">ëŒ€ê¸°</span>
            {% elif booking[6] == 'confirmed' %}
              <span class="status-badge status-confirmed">ìŠ¹ì¸</span>
            {% elif booking[6] == 'cancelled' %}
              <span class="status-badge status-cancelled">ì·¨ì†Œí•¨</span>
            {% endif %}
          </td>
          <td>
            {% if booking[6] != 'cancelled' %}
            <button class="btn-modern btn-delete" onclick="showCancelModal(event, {{ booking[0] }}, '{{ booking[1] }}', '{{ booking[2] }}')">
              ì·¨ì†Œ
            </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="pagination" id="bookingsPagination"></div>
  {% else %}
  <div class="empty-state">
    <div class="empty-state-icon">ğŸ“­</div>
    <p>ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤</p>
  </div>
  {% endif %}
</div>

<!-- ì˜ˆì•½ ìƒì„¸ ëª¨ë‹¬ -->
<div class="modal fade" id="bookingDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 1rem; border: none;">
      <div class="modal-header" style="background: linear-gradient(135deg, #6b4c3b 0%, #4a3f35 100%); color: white; border-radius: 1rem 1rem 0 0;">
        <h5 class="modal-title">ğŸ“‹ ì˜ˆì•½ ìƒì„¸ ì •ë³´</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="bookingDetailContent" style="padding: 2rem;">
        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
      </div>
    </div>
  </div>
</div>

<!-- ì˜ˆì•½ ì·¨ì†Œ ëª¨ë‹¬ -->
<div class="modal fade" id="cancelBookingModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 1rem; border: none;">
      <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border-radius: 1rem 1rem 0 0;">
        <h5 class="modal-title">âš ï¸ ì˜ˆì•½ ì·¨ì†Œ</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" id="cancelBookingForm">
        <div class="modal-body" style="padding: 2rem;">
          <input type="hidden" name="cancel_booking_id" id="cancelBookingId">
          <div class="mb-3">
            <p><strong>ì˜ˆì•½ì:</strong> <span id="cancelBookingName"></span></p>
            <p><strong>ì´ë©”ì¼:</strong> <span id="cancelBookingEmail"></span></p>
          </div>
          <div class="mb-3">
            <label for="cancelReason" class="form-label">ì·¨ì†Œ ì‚¬ìœ  <span style="color: red;">*</span></label>
            <textarea class="form-control" id="cancelReason" name="cancel_reason" rows="4"
                      placeholder="ì˜ˆì•½ ì·¨ì†Œ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”. ì´ ë‚´ìš©ì€ ì˜ˆì•½ìì—ê²Œ ì´ë©”ì¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤." required></textarea>
          </div>
        </div>
        <div class="modal-footer" style="border-top: 1px solid #e9ecef;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
          <button type="submit" class="btn btn-danger">ì·¨ì†Œ í™•ì¸</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Booking Links -->
<div class="section">
  <div class="section-header">
    <h2 class="section-title">ğŸ”— ì˜ˆì•½ ë§í¬ ê´€ë¦¬</h2>
    <div class="d-flex gap-2">
      <form method="post" class="d-inline" onsubmit="return confirm('ì‚¬ìš©ëœ/ë§Œë£Œëœ ëª¨ë“  ë§í¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
        <input type="hidden" name="delete_used_links" value="1">
        <button type="submit" class="btn-modern btn-delete">âœ• ì‚¬ìš©ëœ/ë§Œë£Œëœ ë§í¬ ì‚­ì œ</button>
      </form>
      <button class="btn-modern btn-create" onclick="document.getElementById('createLinkForm').style.display='block'">+ ìƒˆ ë§í¬ ìƒì„±</button>
    </div>
  </div>

  <!-- Create Form (Initially Hidden) -->
  <div id="createLinkForm" style="display: none; margin-bottom: 1.5rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
    <form method="post">
      <input type="hidden" name="create_booking_link" value="1">
      <div class="mb-3">
        <label class="form-label">ë§í¬ ì´ë¦„</label>
        <input type="text" name="link_name" class="form-control" placeholder="ì˜ˆ: 5ì›” ì»¤í”¼ì±— ë§í¬" required>
      </div>
      <button type="submit" class="btn-modern btn-approve">ìƒì„±</button>
      <button type="button" class="btn-modern btn-reject" onclick="document.getElementById('createLinkForm').style.display='none'">ì·¨ì†Œ</button>
    </form>
  </div>

  {% if booking_links %}
  <div class="table-responsive">
    <table class="table-modern" id="linksTable">
      <thead>
        <tr>
          <th>ë§í¬ ì´ë¦„</th>
          <th>ì˜ˆì•½ URL</th>
          <th>ìƒì„±ì¼</th>
          <th>ìƒíƒœ</th>
          <th>ì‘ì—…</th>
        </tr>
      </thead>
      <tbody id="linksTableBody">
        {% for link in booking_links %}
        <tr data-link-row>
          <td><strong>{{ link[2] }}</strong></td>
          <td>
            <div class="d-flex align-items-center gap-2">
              <input type="text" class="form-control form-control-sm font-monospace"
                     id="link-url-{{ link[0] }}"
                     value="{{ host_url }}book/{{ link[1] }}"
                     readonly
                     style="font-size: 0.75rem; max-width: 300px;">
              <button class="btn-modern btn-approve btn-sm"
                      onclick="copyLink(event, '{{ link[0] }}')"
                      title="ë³µì‚¬">
                ğŸ“‹
              </button>
            </div>
          </td>
          <td class="small">{{ link[3][:10] }}</td>
          <td>
            {% if link[6] == 1 %}
              <span class="link-badge link-used">ì‚¬ìš©ë¨</span>
            {% elif link[7] == 1 %}
              <span class="link-badge link-active">í™œì„±</span>
            {% else %}
              <span class="link-badge link-expired">ë§Œë£Œ</span>
            {% endif %}
          </td>
          <td>
            <div class="d-flex gap-1">
              {% if link[7] == 1 and link[6] == 0 %}
              <form method="post" class="d-inline">
                <input type="hidden" name="deactivate_link_id" value="{{ link[0] }}">
                <button type="submit" class="btn-modern btn-reject btn-sm">ë¹„í™œì„±í™”</button>
              </form>
              {% elif link[7] == 0 and link[6] == 0 %}
              <form method="post" class="d-inline">
                <input type="hidden" name="activate_link_id" value="{{ link[0] }}">
                <button type="submit" class="btn-modern btn-approve btn-sm">í™œì„±í™”</button>
              </form>
              {% endif %}
              <form method="post" class="d-inline" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì˜ˆì•½ì´ ìˆìœ¼ë©´ ë¹„í™œì„±í™”ë§Œ ë©ë‹ˆë‹¤)');">
                <input type="hidden" name="delete_link_id" value="{{ link[0] }}">
                <button type="submit" class="btn-modern btn-delete btn-sm" title="ì‚­ì œ">âœ•</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="pagination" id="linksPagination"></div>
  {% else %}
  <div class="empty-state">
    <div class="empty-state-icon">ğŸ”—</div>
    <p>ìƒì„±ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤</p>
  </div>
  {% endif %}
</div>

</div><!-- End of admin-content -->

<script>
// ì´ë©”ì¼ ë§í¬ì—ì„œ íŠ¹ì • ì˜ˆì•½ìœ¼ë¡œ ì´ë™
window.addEventListener('DOMContentLoaded', function() {
  const hash = window.location.hash;
  if (hash.startsWith('#booking-')) {
    const bookingId = hash.replace('#booking-', '');
    setTimeout(() => {
      const bookingRow = document.querySelector(`tr[data-booking-id="${bookingId}"]`);
      if (bookingRow) {
        bookingRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        bookingRow.style.backgroundColor = '#fff3cd';
        setTimeout(() => {
          bookingRow.style.backgroundColor = '';
        }, 3000);
      }
    }, 300);
  }

  // Pagination for booking links and all bookings
  initBookingsPagination();
  initLinksPagination();
});

// ì „ì²´ ì˜ˆì•½ í…Œì´ë¸” í˜ì´ì§€ë„¤ì´ì…˜
function initBookingsPagination() {
  const bookingsTableBody = document.getElementById('bookingsTableBody');
  if (!bookingsTableBody) return;

  const rows = Array.from(bookingsTableBody.querySelectorAll('tr[data-booking-row]'));
  const itemsPerPage = 10;
  const totalPages = Math.ceil(rows.length / itemsPerPage);
  let currentPage = 1;

  function renderPage(page) {
    // Hide all rows
    rows.forEach(row => row.style.display = 'none');

    // Show current page rows
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    rows.slice(start, end).forEach(row => row.style.display = '');

    // Update pagination controls
    renderPagination(page);
  }

  function renderPagination(page) {
    const paginationContainer = document.getElementById('bookingsPagination');
    if (!paginationContainer || totalPages <= 1) {
      paginationContainer.innerHTML = '';
      return;
    }

    let html = '';

    // Previous button
    html += `<button onclick="changeBookingPage(${page - 1})" ${page === 1 ? 'disabled' : ''}>â—€</button>`;

    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage < maxVisiblePages - 1) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    if (startPage > 1) {
      html += `<button onclick="changeBookingPage(1)">1</button>`;
      if (startPage > 2) {
        html += `<span class="page-info">...</span>`;
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      html += `<button onclick="changeBookingPage(${i})" class="${i === page ? 'active' : ''}">${i}</button>`;
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        html += `<span class="page-info">...</span>`;
      }
      html += `<button onclick="changeBookingPage(${totalPages})">${totalPages}</button>`;
    }

    // Next button
    html += `<button onclick="changeBookingPage(${page + 1})" ${page === totalPages ? 'disabled' : ''}>â–¶</button>`;

    // Page info
    html += `<span class="page-info">${page} / ${totalPages}</span>`;

    paginationContainer.innerHTML = html;
  }

  // Make changeBookingPage globally accessible
  window.changeBookingPage = function(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderPage(currentPage);
  };

  // Initial render
  renderPage(currentPage);
}

// ë§í¬ í…Œì´ë¸” í˜ì´ì§€ë„¤ì´ì…˜
function initLinksPagination() {
  const linksTableBody = document.getElementById('linksTableBody');
  if (!linksTableBody) return;

  const rows = Array.from(linksTableBody.querySelectorAll('tr[data-link-row]'));
  const itemsPerPage = 10;
  const totalPages = Math.ceil(rows.length / itemsPerPage);
  let currentPage = 1;

  function renderPage(page) {
    // Hide all rows
    rows.forEach(row => row.style.display = 'none');

    // Show current page rows
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    rows.slice(start, end).forEach(row => row.style.display = '');

    // Update pagination controls
    renderPagination(page);
  }

  function renderPagination(page) {
    const paginationContainer = document.getElementById('linksPagination');
    if (!paginationContainer || totalPages <= 1) {
      paginationContainer.innerHTML = '';
      return;
    }

    let html = '';

    // Previous button
    html += `<button onclick="changeLinkPage(${page - 1})" ${page === 1 ? 'disabled' : ''}>â—€</button>`;

    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage < maxVisiblePages - 1) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    if (startPage > 1) {
      html += `<button onclick="changeLinkPage(1)">1</button>`;
      if (startPage > 2) {
        html += `<span class="page-info">...</span>`;
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      html += `<button onclick="changeLinkPage(${i})" class="${i === page ? 'active' : ''}">${i}</button>`;
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        html += `<span class="page-info">...</span>`;
      }
      html += `<button onclick="changeLinkPage(${totalPages})">${totalPages}</button>`;
    }

    // Next button
    html += `<button onclick="changeLinkPage(${page + 1})" ${page === totalPages ? 'disabled' : ''}>â–¶</button>`;

    // Page info
    html += `<span class="page-info">${page} / ${totalPages}</span>`;

    paginationContainer.innerHTML = html;
  }

  // Make changeLinkPage globally accessible
  window.changeLinkPage = function(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderPage(currentPage);
  };

  // Initial render
  renderPage(currentPage);
}

// ì˜ˆì•½ ìƒì„¸ ì •ë³´ í‘œì‹œ (data ì†ì„±ì—ì„œ ì½ê¸°)
function showBookingDetailFromRow(row) {
  const id = row.dataset.bookingId;
  const name = row.dataset.bookingName;
  const email = row.dataset.bookingEmail;
  const phone = row.dataset.bookingPhone;
  const purpose = row.dataset.bookingPurpose;
  const selectedSlot = row.dataset.bookingSlot;
  const status = row.dataset.bookingStatus;
  const meetLink = row.dataset.bookingMeet;
  const createdAt = row.dataset.bookingCreated;
  const linkName = row.dataset.bookingLink;
  const cancelReason = row.dataset.bookingCancelReason;

  let statusBadge = '';
  if (status === 'pending') {
    statusBadge = '<span class="status-badge status-pending">ëŒ€ê¸°</span>';
  } else if (status === 'confirmed') {
    statusBadge = '<span class="status-badge status-confirmed">ìŠ¹ì¸</span>';
  } else if (status === 'cancelled') {
    statusBadge = '<span class="status-badge status-cancelled">ì·¨ì†Œí•¨</span>';
  }

  const content = `
    <div style="display: grid; gap: 1.25rem; font-family: 'Inter', sans-serif;">
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">ì˜ˆì•½ ID</label>
        <div style="font-size: 1.125rem; font-weight: 600; color: #4a3f35; margin-top: 0.25rem;">#${id}</div>
      </div>
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">ìƒíƒœ</label>
        <div style="margin-top: 0.25rem;">${statusBadge}</div>
      </div>
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">ì´ë¦„</label>
        <div style="font-size: 1rem; color: #4a3f35; margin-top: 0.25rem;">${name}</div>
      </div>
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">ì´ë©”ì¼</label>
        <div style="font-size: 0.875rem; color: #4a3f35; margin-top: 0.25rem;">${email}</div>
      </div>
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">ì „í™”ë²ˆí˜¸</label>
        <div style="font-size: 0.875rem; color: #4a3f35; margin-top: 0.25rem;">${phone || '-'}</div>
      </div>
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">í¬ë§ ì‹œê°„</label>
        <div style="font-size: 1.125rem; color: #6b4c3b; font-weight: 600; margin-top: 0.25rem;">ğŸ“… ${formatDateTime(selectedSlot)}</div>
        ${getTimeRemaining(selectedSlot) ? `<div style="font-size: 0.875rem; color: #6b4c3b; margin-top: 0.5rem; font-weight: 500;">â° ${getTimeRemaining(selectedSlot)}</div>` : ''}
      </div>
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">ìš©ë¬´</label>
        <div style="font-size: 0.875rem; color: #4a3f35; background: #f8f9fa; padding: 0.875rem; border-radius: 8px; margin-top: 0.25rem; line-height: 1.5;">${purpose || '-'}</div>
      </div>
      ${meetLink ? `
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Google Meet ë§í¬</label>
        <div style="margin-top: 0.25rem;">
          <a href="${meetLink}" target="_blank" style="font-size: 0.875rem; color: #6b4c3b; text-decoration: none; word-break: break-all; display: inline-block; padding: 0.5rem 0.75rem; background: #f3ede7; border-radius: 6px;">
            ğŸ”— ${meetLink}
          </a>
        </div>
      </div>
      ` : ''}
      ${linkName ? `
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">ì˜ˆì•½ ë§í¬</label>
        <div style="font-size: 0.875rem; color: #4a3f35; margin-top: 0.25rem;">${linkName}</div>
      </div>
      ` : ''}
      ${cancelReason ? `
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">ì·¨ì†Œ ì‚¬ìœ </label>
        <div style="font-size: 0.875rem; color: #dc3545; margin-top: 0.25rem; padding: 0.75rem; background: #f8d7da; border-radius: 6px; white-space: pre-wrap;">${cancelReason}</div>
      </div>
      ` : ''}
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">ìƒì„±ì¼</label>
        <div style="font-size: 0.875rem; color: #6c757d; margin-top: 0.25rem;">${createdAt ? createdAt.substring(0, 19).replace('T', ' ') : '-'}</div>
      </div>
    </div>
  `;

  document.getElementById('bookingDetailContent').innerHTML = content;
  const modal = new bootstrap.Modal(document.getElementById('bookingDetailModal'));
  modal.show();
}

// ì·¨ì†Œ ëª¨ë‹¬ í‘œì‹œ
function showCancelModal(event, bookingId, name, email) {
  event.stopPropagation();
  document.getElementById('cancelBookingId').value = bookingId;
  document.getElementById('cancelBookingName').textContent = name;
  document.getElementById('cancelBookingEmail').textContent = email;
  document.getElementById('cancelReason').value = '';

  const modal = new bootstrap.Modal(document.getElementById('cancelBookingModal'));
  modal.show();
}

// ë§í¬ ë³µì‚¬ í•¨ìˆ˜
function copyLink(event, linkId) {
  const input = document.getElementById('link-url-' + linkId);
  input.select();
  input.setSelectionRange(0, 99999); // ëª¨ë°”ì¼ ì§€ì›

  navigator.clipboard.writeText(input.value).then(() => {
    // ë³µì‚¬ ì„±ê³µ ì•Œë¦¼
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = 'âœ…';
    setTimeout(() => {
      button.innerHTML = originalText;
    }, 2000);
  }).catch(err => {
    alert('ë³µì‚¬ ì‹¤íŒ¨: ' + err);
  });
}

// 10ë¶„ í›„ ìë™ ë¡œê·¸ì•„ì›ƒ
setTimeout(() => {
  alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì–´ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.");
  window.location.href = "{{ url_for('home') }}";
}, 600000);
</script>
{% endblock %}
