{% extends "base.html" %}

{% block title %}관리자 페이지 | 커피챗{% endblock %}

{% block content %}
<style>
  body {
    background-color: #f3ede7;
    font-family: 'Inter', sans-serif;
  }

  .admin-header {
    background: linear-gradient(135deg, #6b4c3b 0%, #4a3f35 100%);
    color: white;
    padding: 2rem;
    border-radius: 1rem;
    margin-bottom: 2rem;
  }

  .admin-header h1 {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 600;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: white;
    padding: 1rem;
    border-radius: 0.75rem;
    border: 1px solid #e9ecef;
    transition: transform 0.2s, box-shadow 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 0.5rem;
  }

  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .stat-card .icon {
    font-size: 2rem;
  }

  .stat-card .value {
    font-size: 1.75rem;
    font-weight: 700;
    color: #6b4c3b;
    line-height: 1;
  }

  .stat-card .label {
    color: #6c757d;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .section {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid #e9ecef;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #f3ede7;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: #4a3f35;
    margin: 0;
  }

  .table-modern {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .table-modern thead th {
    background-color: #f8f9fa;
    color: #6b4c3b;
    font-weight: 600;
    padding: 1rem;
    text-align: center;
    border-bottom: 2px solid #e9ecef;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .table-modern tbody tr {
    border-bottom: 1px solid #f3ede7;
    transition: background-color 0.2s;
  }

  .table-modern tbody tr:hover {
    background-color: #f8f9fa;
  }

  .table-modern tbody td {
    padding: 1rem;
    vertical-align: middle;
    white-space: nowrap;
    text-align: center;
  }

  .table-modern tbody td.wrap {
    white-space: normal;
    max-width: 200px;
  }

  .table-modern tbody td.email-cell {
    max-width: 150px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .table-modern tbody td.time-cell {
    max-width: 120px;
    font-size: 0.8rem;
  }

  .table-modern tbody td.remaining-cell {
    max-width: 100px;
    font-size: 0.8rem;
  }

  .status-badge {
    display: inline-block;
    padding: 0.35rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-pending {
    background-color: #fff3cd;
    color: #856404;
  }

  .status-confirmed {
    background-color: #d4edda;
    color: #155724;
  }

  .status-cancelled {
    background-color: #f8d7da;
    color: #721c24;
  }

  .btn-modern {
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    border: none;
    font-weight: 500;
    font-size: 0.875rem;
    transition: all 0.2s;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 32px;
  }

  .btn-modern.btn-sm {
    padding: 0.35rem 0.6rem;
    font-size: 0.75rem;
    min-height: 28px;
  }

  .btn-approve {
    background-color: #6b4c3b;
    color: white;
  }

  .btn-approve:hover {
    background-color: #4a3f35;
    transform: translateY(-1px);
  }

  .btn-reject {
    background-color: #dc3545;
    color: white;
  }

  .btn-reject:hover {
    background-color: #c82333;
  }

  .btn-create {
    background-color: #6b4c3b;
    color: white;
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    border: none;
    font-weight: 500;
    font-size: 0.875rem;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 32px;
  }

  .btn-create:hover {
    background-color: #4a3f35;
    transform: translateY(-1px);
  }

  .btn-delete {
    background-color: #6c757d;
    color: white;
  }

  .btn-delete:hover {
    background-color: #5a6268;
  }

  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
  }

  .empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .link-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .link-active {
    background-color: #d4edda;
    color: #155724;
  }

  .link-used {
    background-color: #f8d7da;
    color: #721c24;
  }

  .link-expired {
    background-color: #e2e3e5;
    color: #6c757d;
  }

  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
  }

  .pagination button {
    padding: 0.5rem 0.75rem;
    border: 1px solid #e9ecef;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.875rem;
  }

  .pagination button:hover:not(:disabled) {
    background: #f8f9fa;
    border-color: #6b4c3b;
  }

  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pagination button.active {
    background: #6b4c3b;
    color: white;
    border-color: #6b4c3b;
  }

  .pagination .page-info {
    color: #6c757d;
    font-size: 0.875rem;
    padding: 0 1rem;
  }

  @media (max-width: 768px) {
    /* 헤더 */
    .admin-header {
      padding: 1rem;
    }

    .admin-header h1 {
      font-size: 1.25rem;
    }

    /* 통계 카드 2열 */
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    .stat-card {
      padding: 0.75rem;
    }

    .stat-card .icon {
      font-size: 1.5rem;
    }

    .stat-card .value {
      font-size: 1.5rem;
    }

    /* 섹션 */
    .section {
      padding: 1rem;
      border-radius: 0.75rem;
    }

    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .section-title {
      font-size: 1.1rem;
    }

    /* 테이블 스크롤 */
    .table-responsive {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .table-modern {
      font-size: 0.8rem;
      min-width: 600px;
    }

    .table-modern thead th,
    .table-modern tbody td {
      padding: 0.5rem 0.25rem;
      white-space: nowrap;
    }

    /* 버튼 */
    .btn-sm {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }

    /* 월 네비게이션 */
    .month-nav {
      flex-direction: column;
      gap: 0.5rem;
    }

    /* 필터 폼 */
    .filter-form {
      flex-direction: column;
      align-items: stretch;
    }

    .filter-form .form-control,
    .filter-form .form-select {
      width: 100%;
    }
  }

  @media (max-width: 768px) {
    /* 모바일에서 통계 카드를 맨 밑으로 이동 */
    #admin-content {
      display: flex;
      flex-direction: column;
    }

    #stats-section {
      order: 999;
    }
  }

  @media (max-width: 480px) {
    /* 섹션 패딩 축소 */
    .section {
      padding: 0.75rem;
    }

    /* 테이블 더 축소 */
    .table-modern {
      font-size: 0.75rem;
    }

    .table-modern thead th,
    .table-modern tbody td {
      padding: 0.4rem 0.2rem;
    }
  }
</style>

<!-- Header -->
<div class="admin-header">
  <div class="d-flex justify-content-between align-items-center">
    <h1>☕ 커피챗 관리자</h1>
    <form method="post" action="{{ url_for('admin_logout') }}" class="m-0">
      <button type="submit" class="btn btn-outline-light btn-sm">로그아웃</button>
    </form>
  </div>
</div>

<div id="admin-content">
  <!-- Stats Section -->
  <div id="stats-section">
    <!-- Stats Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h2 style="font-size: 1.25rem; font-weight: 600; color: #4a3f35; margin: 0;">📊 통계</h2>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <button onclick="changeStatsMonth(-1)" class="btn-modern" style="padding: 0.5rem 0.75rem;">
          ◀
        </button>
        <span id="statsMonthLabel" style="font-size: 1rem; font-weight: 600; color: #6b4c3b; min-width: 100px; text-align: center;">
          <!-- JavaScript로 채워짐 -->
        </span>
        <button onclick="changeStatsMonth(1)" class="btn-modern" style="padding: 0.5rem 0.75rem;">
          ▶
        </button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="icon">⏳</div>
        <div class="value" id="stat-pending">0</div>
        <div class="label">승인 대기</div>
      </div>
      <div class="stat-card">
        <div class="icon">✅</div>
        <div class="value" id="stat-confirmed">0</div>
        <div class="label">승인 완료</div>
      </div>
      <div class="stat-card">
        <div class="icon">❌</div>
        <div class="value" id="stat-cancelled">0</div>
        <div class="label">취소함</div>
      </div>
      <div class="stat-card">
        <div class="icon">🔗</div>
        <div class="value" id="stat-links">0</div>
        <div class="label">전체 활성 링크</div>
      </div>
    </div>
  </div>

<script>
// 날짜 문자열 정규화 함수
function normalizeDateTime(isoString) {
  if (!isoString) return null;
  let normalized = isoString.trim();
  // 2025-10-16 11:30 -> 2025-10-16T11:30:00
  if (normalized.match(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/)) {
    normalized = normalized.replace(' ', 'T') + ':00';
  }
  return normalized;
}

// 시간 포맷팅 함수 (먼저 정의)
function formatDateTime(isoString) {
  if (!isoString) return '-';
  const normalized = normalizeDateTime(isoString);
  const date = new Date(normalized);
  if (isNaN(date.getTime())) return '-';

  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  let hours = date.getHours();
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12 || 12;
  return `${year}-${month}-${day} ${hours}:${minutes} ${ampm}`;
}

// 짧은 시간 포맷 (테이블용)
function formatDateTimeShort(isoString) {
  if (!isoString) return '-';
  const normalized = normalizeDateTime(isoString);
  const date = new Date(normalized);
  if (isNaN(date.getTime())) return '-';

  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  let hours = date.getHours();
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const ampm = hours >= 12 ? 'PM' : 'AM';
  hours = hours % 12 || 12;
  return `${month}/${day} ${hours}:${minutes}${ampm}`;
}

// 남은 시간 계산 함수
function getTimeRemaining(isoString) {
  if (!isoString) return '';
  const now = new Date();

  const normalized = normalizeDateTime(isoString);
  const target = new Date(normalized);

  // 유효한 날짜인지 확인
  if (isNaN(target.getTime())) {
    console.error('Invalid date:', isoString);
    return '-';
  }

  const diff = target - now;

  if (diff <= 0) return '-';

  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
  const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

  if (days > 0) {
    return `${days}일 ${hours}시간`;
  } else if (hours > 0) {
    return `${hours}시간 ${minutes}분`;
  } else if (minutes > 0) {
    return `${minutes}분`;
  } else {
    return '곧 시작';
  }
}

// 전체 예약 데이터 (서버에서 전달)
const allBookings = {{ bookings|tojson }};
const allLinks = {{ booking_links|tojson }};
let currentStatsMonth = new Date();

function updateStats() {
  const year = currentStatsMonth.getFullYear();
  const month = currentStatsMonth.getMonth() + 1;

  // 월 라벨 업데이트
  document.getElementById('statsMonthLabel').textContent = `${year}년 ${month}월`;

  // 해당 월의 예약만 필터링
  const monthBookings = allBookings.filter(booking => {
    if (!booking[5]) return false; // selected_slot이 없으면 제외
    const bookingDate = new Date(booking[5]);
    return bookingDate.getFullYear() === year && bookingDate.getMonth() + 1 === month;
  });

  // 통계 업데이트
  const pending = monthBookings.filter(b => b[6] === 'pending').length;
  const confirmed = monthBookings.filter(b => b[6] === 'confirmed').length;
  const cancelled = monthBookings.filter(b => b[6] === 'cancelled').length;
  // 전체 활성 링크 (used=0, active=1) - 월별 필터링 없음
  const activeLinks = allLinks.filter(l => l[6] === 0 && l[7] === 1).length;

  document.getElementById('stat-pending').textContent = pending;
  document.getElementById('stat-confirmed').textContent = confirmed;
  document.getElementById('stat-cancelled').textContent = cancelled;
  document.getElementById('stat-links').textContent = activeLinks;
}

function changeStatsMonth(delta) {
  currentStatsMonth.setMonth(currentStatsMonth.getMonth() + delta);
  updateStats();
}

// 초기 통계 표시
updateStats();
</script>

<!-- Pending Bookings (우선순위 높음) -->
{% set pending_bookings = bookings|selectattr('6', 'equalto', 'pending')|list %}
{% if pending_bookings %}
<div class="section">
  <div class="section-header">
    <h2 class="section-title">🔔 승인 필요 ({{ pending_bookings|length }}건)</h2>
  </div>
  <div class="table-responsive">
    <table class="table-modern">
      <thead>
        <tr>
          <th>이름</th>
          <th>이메일</th>
          <th>희망 시간</th>
          <th>용무</th>
          <th style="width: 200px;">작업</th>
        </tr>
      </thead>
      <tbody>
        {% for booking in pending_bookings %}
        <tr data-booking-id="{{ booking[0] }}">
          <td><strong>{{ booking[1] }}</strong></td>
          <td class="small">{{ booking[2] }}</td>
          <td class="small">{{ booking[5] }}</td>
          <td class="small">{{ booking[4][:30] }}...</td>
          <td>
            <form method="post" class="d-inline" onsubmit="return confirm('승인하시겠습니까?');">
              <input type="hidden" name="approve_booking_id" value="{{ booking[0] }}">
              <button type="submit" class="btn-modern btn-approve">✓ 승인</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- All Bookings -->
<div class="section">
  <div class="section-header">
    <h2 class="section-title">📅 전체 예약</h2>
  </div>
  {% if bookings %}
  <div class="table-responsive">
    <table class="table-modern" id="bookingsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>이름</th>
          <th>이메일</th>
          <th>시간</th>
          <th>남은 시간</th>
          <th>상태</th>
          <th>액션</th>
        </tr>
      </thead>
      <tbody id="bookingsTableBody">
        {% for booking in bookings %}
        <tr data-booking-id="{{ booking[0] }}"
            data-booking-row
            data-booking-name="{{ booking[1] }}"
            data-booking-email="{{ booking[2] }}"
            data-booking-phone="{{ booking[3] }}"
            data-booking-purpose="{{ booking[4] }}"
            data-booking-slot="{{ booking[5] }}"
            data-booking-status="{{ booking[6] }}"
            data-booking-meet="{{ booking[7] or '' }}"
            data-booking-created="{{ booking[8] or '' }}"
            data-booking-link="{{ booking[9] or '' }}"
            data-booking-cancel-reason="{{ booking[10] or '' }}">
          <td onclick="showBookingDetailFromRow(this.parentElement)" style="cursor: pointer;">{{ booking[0] }}</td>
          <td onclick="showBookingDetailFromRow(this.parentElement)" style="cursor: pointer;"><strong>{{ booking[1] }}</strong></td>
          <td class="email-cell" onclick="showBookingDetailFromRow(this.parentElement)" style="cursor: pointer;" title="{{ booking[2] }}">{{ booking[2] }}</td>
          <td class="time-cell" onclick="showBookingDetailFromRow(this.parentElement)" style="cursor: pointer;">
            {% if booking[5] %}
            <script>document.write(formatDateTimeShort('{{ booking[5] }}'));</script>
            {% else %}
            -
            {% endif %}
          </td>
          <td class="remaining-cell" onclick="showBookingDetailFromRow(this.parentElement)" style="cursor: pointer; color: #6b4c3b; font-weight: 600;">
            {% if booking[5] %}
            <script>
              const remaining = getTimeRemaining('{{ booking[5] }}');
              if (remaining) document.write(remaining);
              else document.write('-');
            </script>
            {% else %}
            -
            {% endif %}
          </td>
          <td onclick="showBookingDetailFromRow(this.parentElement)" style="cursor: pointer;">
            {% if booking[6] == 'pending' %}
              <span class="status-badge status-pending">대기</span>
            {% elif booking[6] == 'confirmed' %}
              <span class="status-badge status-confirmed">승인</span>
            {% elif booking[6] == 'cancelled' %}
              <span class="status-badge status-cancelled">취소함</span>
            {% endif %}
          </td>
          <td>
            {% if booking[6] != 'cancelled' %}
            <button class="btn-modern btn-delete" onclick="showCancelModal(event, {{ booking[0] }}, '{{ booking[1] }}', '{{ booking[2] }}')">
              취소
            </button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="pagination" id="bookingsPagination"></div>
  {% else %}
  <div class="empty-state">
    <div class="empty-state-icon">📭</div>
    <p>예약이 없습니다</p>
  </div>
  {% endif %}
</div>

<!-- 예약 상세 모달 -->
<div class="modal fade" id="bookingDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 1rem; border: none;">
      <div class="modal-header" style="background: linear-gradient(135deg, #6b4c3b 0%, #4a3f35 100%); color: white; border-radius: 1rem 1rem 0 0;">
        <h5 class="modal-title">📋 예약 상세 정보</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="bookingDetailContent" style="padding: 2rem;">
        <!-- 동적으로 채워짐 -->
      </div>
    </div>
  </div>
</div>

<!-- 예약 취소 모달 -->
<div class="modal fade" id="cancelBookingModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 1rem; border: none;">
      <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border-radius: 1rem 1rem 0 0;">
        <h5 class="modal-title">⚠️ 예약 취소</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" id="cancelBookingForm">
        <div class="modal-body" style="padding: 2rem;">
          <input type="hidden" name="cancel_booking_id" id="cancelBookingId">
          <div class="mb-3">
            <p><strong>예약자:</strong> <span id="cancelBookingName"></span></p>
            <p><strong>이메일:</strong> <span id="cancelBookingEmail"></span></p>
          </div>
          <div class="mb-3">
            <label for="cancelReason" class="form-label">취소 사유 <span style="color: red;">*</span></label>
            <textarea class="form-control" id="cancelReason" name="cancel_reason" rows="4"
                      placeholder="예약 취소 사유를 입력하세요. 이 내용은 예약자에게 이메일로 전송됩니다." required></textarea>
          </div>
        </div>
        <div class="modal-footer" style="border-top: 1px solid #e9ecef;">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          <button type="submit" class="btn btn-danger">취소 확인</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Booking Links -->
<div class="section">
  <div class="section-header">
    <h2 class="section-title">🔗 예약 링크 관리</h2>
    <div class="d-flex gap-2">
      <form method="post" class="d-inline" onsubmit="return confirm('사용된/만료된 모든 링크를 삭제하시겠습니까?');">
        <input type="hidden" name="delete_used_links" value="1">
        <button type="submit" class="btn-modern btn-delete">✕ 사용된/만료된 링크 삭제</button>
      </form>
      <button class="btn-modern btn-create" onclick="document.getElementById('createLinkForm').style.display='block'">+ 새 링크 생성</button>
    </div>
  </div>

  <!-- Create Form (Initially Hidden) -->
  <div id="createLinkForm" style="display: none; margin-bottom: 1.5rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
    <form method="post">
      <input type="hidden" name="create_booking_link" value="1">
      <div class="mb-3">
        <label class="form-label">링크 이름</label>
        <input type="text" name="link_name" class="form-control" placeholder="예: 5월 커피챗 링크" required>
      </div>
      <button type="submit" class="btn-modern btn-approve">생성</button>
      <button type="button" class="btn-modern btn-reject" onclick="document.getElementById('createLinkForm').style.display='none'">취소</button>
    </form>
  </div>

  {% if booking_links %}
  <div class="table-responsive">
    <table class="table-modern" id="linksTable">
      <thead>
        <tr>
          <th>링크 이름</th>
          <th>예약 URL</th>
          <th>생성일</th>
          <th>상태</th>
          <th>작업</th>
        </tr>
      </thead>
      <tbody id="linksTableBody">
        {% for link in booking_links %}
        <tr data-link-row>
          <td><strong>{{ link[2] }}</strong></td>
          <td>
            <div class="d-flex align-items-center gap-2">
              <input type="text" class="form-control form-control-sm font-monospace"
                     id="link-url-{{ link[0] }}"
                     value="{{ host_url }}book/{{ link[1] }}"
                     readonly
                     style="font-size: 0.75rem; max-width: 300px;">
              <button class="btn-modern btn-approve btn-sm"
                      onclick="copyLink(event, '{{ link[0] }}')"
                      title="복사">
                📋
              </button>
            </div>
          </td>
          <td class="small">{{ link[3][:10] }}</td>
          <td>
            {% if link[6] == 1 %}
              <span class="link-badge link-used">사용됨</span>
            {% elif link[7] == 1 %}
              <span class="link-badge link-active">활성</span>
            {% else %}
              <span class="link-badge link-expired">만료</span>
            {% endif %}
          </td>
          <td>
            <div class="d-flex gap-1">
              {% if link[7] == 1 and link[6] == 0 %}
              <form method="post" class="d-inline">
                <input type="hidden" name="deactivate_link_id" value="{{ link[0] }}">
                <button type="submit" class="btn-modern btn-reject btn-sm">비활성화</button>
              </form>
              {% elif link[7] == 0 and link[6] == 0 %}
              <form method="post" class="d-inline">
                <input type="hidden" name="activate_link_id" value="{{ link[0] }}">
                <button type="submit" class="btn-modern btn-approve btn-sm">활성화</button>
              </form>
              {% endif %}
              <form method="post" class="d-inline" onsubmit="return confirm('정말 삭제하시겠습니까? (예약이 있으면 비활성화만 됩니다)');">
                <input type="hidden" name="delete_link_id" value="{{ link[0] }}">
                <button type="submit" class="btn-modern btn-delete btn-sm" title="삭제">✕</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="pagination" id="linksPagination"></div>
  {% else %}
  <div class="empty-state">
    <div class="empty-state-icon">🔗</div>
    <p>생성된 링크가 없습니다</p>
  </div>
  {% endif %}
</div>

</div><!-- End of admin-content -->

<script>
// 이메일 링크에서 특정 예약으로 이동
window.addEventListener('DOMContentLoaded', function() {
  const hash = window.location.hash;
  if (hash.startsWith('#booking-')) {
    const bookingId = hash.replace('#booking-', '');
    setTimeout(() => {
      const bookingRow = document.querySelector(`tr[data-booking-id="${bookingId}"]`);
      if (bookingRow) {
        bookingRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        bookingRow.style.backgroundColor = '#fff3cd';
        setTimeout(() => {
          bookingRow.style.backgroundColor = '';
        }, 3000);
      }
    }, 300);
  }

  // Pagination for booking links and all bookings
  initBookingsPagination();
  initLinksPagination();
});

// 전체 예약 테이블 페이지네이션
function initBookingsPagination() {
  const bookingsTableBody = document.getElementById('bookingsTableBody');
  if (!bookingsTableBody) return;

  const rows = Array.from(bookingsTableBody.querySelectorAll('tr[data-booking-row]'));
  const itemsPerPage = 10;
  const totalPages = Math.ceil(rows.length / itemsPerPage);
  let currentPage = 1;

  function renderPage(page) {
    // Hide all rows
    rows.forEach(row => row.style.display = 'none');

    // Show current page rows
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    rows.slice(start, end).forEach(row => row.style.display = '');

    // Update pagination controls
    renderPagination(page);
  }

  function renderPagination(page) {
    const paginationContainer = document.getElementById('bookingsPagination');
    if (!paginationContainer || totalPages <= 1) {
      paginationContainer.innerHTML = '';
      return;
    }

    let html = '';

    // Previous button
    html += `<button onclick="changeBookingPage(${page - 1})" ${page === 1 ? 'disabled' : ''}>◀</button>`;

    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage < maxVisiblePages - 1) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    if (startPage > 1) {
      html += `<button onclick="changeBookingPage(1)">1</button>`;
      if (startPage > 2) {
        html += `<span class="page-info">...</span>`;
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      html += `<button onclick="changeBookingPage(${i})" class="${i === page ? 'active' : ''}">${i}</button>`;
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        html += `<span class="page-info">...</span>`;
      }
      html += `<button onclick="changeBookingPage(${totalPages})">${totalPages}</button>`;
    }

    // Next button
    html += `<button onclick="changeBookingPage(${page + 1})" ${page === totalPages ? 'disabled' : ''}>▶</button>`;

    // Page info
    html += `<span class="page-info">${page} / ${totalPages}</span>`;

    paginationContainer.innerHTML = html;
  }

  // Make changeBookingPage globally accessible
  window.changeBookingPage = function(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderPage(currentPage);
  };

  // Initial render
  renderPage(currentPage);
}

// 링크 테이블 페이지네이션
function initLinksPagination() {
  const linksTableBody = document.getElementById('linksTableBody');
  if (!linksTableBody) return;

  const rows = Array.from(linksTableBody.querySelectorAll('tr[data-link-row]'));
  const itemsPerPage = 10;
  const totalPages = Math.ceil(rows.length / itemsPerPage);
  let currentPage = 1;

  function renderPage(page) {
    // Hide all rows
    rows.forEach(row => row.style.display = 'none');

    // Show current page rows
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    rows.slice(start, end).forEach(row => row.style.display = '');

    // Update pagination controls
    renderPagination(page);
  }

  function renderPagination(page) {
    const paginationContainer = document.getElementById('linksPagination');
    if (!paginationContainer || totalPages <= 1) {
      paginationContainer.innerHTML = '';
      return;
    }

    let html = '';

    // Previous button
    html += `<button onclick="changeLinkPage(${page - 1})" ${page === 1 ? 'disabled' : ''}>◀</button>`;

    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage < maxVisiblePages - 1) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    if (startPage > 1) {
      html += `<button onclick="changeLinkPage(1)">1</button>`;
      if (startPage > 2) {
        html += `<span class="page-info">...</span>`;
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      html += `<button onclick="changeLinkPage(${i})" class="${i === page ? 'active' : ''}">${i}</button>`;
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        html += `<span class="page-info">...</span>`;
      }
      html += `<button onclick="changeLinkPage(${totalPages})">${totalPages}</button>`;
    }

    // Next button
    html += `<button onclick="changeLinkPage(${page + 1})" ${page === totalPages ? 'disabled' : ''}>▶</button>`;

    // Page info
    html += `<span class="page-info">${page} / ${totalPages}</span>`;

    paginationContainer.innerHTML = html;
  }

  // Make changeLinkPage globally accessible
  window.changeLinkPage = function(page) {
    if (page < 1 || page > totalPages) return;
    currentPage = page;
    renderPage(currentPage);
  };

  // Initial render
  renderPage(currentPage);
}

// 예약 상세 정보 표시 (data 속성에서 읽기)
function showBookingDetailFromRow(row) {
  const id = row.dataset.bookingId;
  const name = row.dataset.bookingName;
  const email = row.dataset.bookingEmail;
  const phone = row.dataset.bookingPhone;
  const purpose = row.dataset.bookingPurpose;
  const selectedSlot = row.dataset.bookingSlot;
  const status = row.dataset.bookingStatus;
  const meetLink = row.dataset.bookingMeet;
  const createdAt = row.dataset.bookingCreated;
  const linkName = row.dataset.bookingLink;
  const cancelReason = row.dataset.bookingCancelReason;

  let statusBadge = '';
  if (status === 'pending') {
    statusBadge = '<span class="status-badge status-pending">대기</span>';
  } else if (status === 'confirmed') {
    statusBadge = '<span class="status-badge status-confirmed">승인</span>';
  } else if (status === 'cancelled') {
    statusBadge = '<span class="status-badge status-cancelled">취소함</span>';
  }

  const content = `
    <div style="display: grid; gap: 1.25rem; font-family: 'Inter', sans-serif;">
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">예약 ID</label>
        <div style="font-size: 1.125rem; font-weight: 600; color: #4a3f35; margin-top: 0.25rem;">#${id}</div>
      </div>
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">상태</label>
        <div style="margin-top: 0.25rem;">${statusBadge}</div>
      </div>
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">이름</label>
        <div style="font-size: 1rem; color: #4a3f35; margin-top: 0.25rem;">${name}</div>
      </div>
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">이메일</label>
        <div style="font-size: 0.875rem; color: #4a3f35; margin-top: 0.25rem;">${email}</div>
      </div>
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">전화번호</label>
        <div style="font-size: 0.875rem; color: #4a3f35; margin-top: 0.25rem;">${phone || '-'}</div>
      </div>
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">희망 시간</label>
        <div style="font-size: 1.125rem; color: #6b4c3b; font-weight: 600; margin-top: 0.25rem;">📅 ${formatDateTime(selectedSlot)}</div>
        ${getTimeRemaining(selectedSlot) ? `<div style="font-size: 0.875rem; color: #6b4c3b; margin-top: 0.5rem; font-weight: 500;">⏰ ${getTimeRemaining(selectedSlot)}</div>` : ''}
      </div>
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">용무</label>
        <div style="font-size: 0.875rem; color: #4a3f35; background: #f8f9fa; padding: 0.875rem; border-radius: 8px; margin-top: 0.25rem; line-height: 1.5;">${purpose || '-'}</div>
      </div>
      ${meetLink ? `
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">Google Meet 링크</label>
        <div style="margin-top: 0.25rem;">
          <a href="${meetLink}" target="_blank" style="font-size: 0.875rem; color: #6b4c3b; text-decoration: none; word-break: break-all; display: inline-block; padding: 0.5rem 0.75rem; background: #f3ede7; border-radius: 6px;">
            🔗 ${meetLink}
          </a>
        </div>
      </div>
      ` : ''}
      ${linkName ? `
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">예약 링크</label>
        <div style="font-size: 0.875rem; color: #4a3f35; margin-top: 0.25rem;">${linkName}</div>
      </div>
      ` : ''}
      ${cancelReason ? `
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">취소 사유</label>
        <div style="font-size: 0.875rem; color: #dc3545; margin-top: 0.25rem; padding: 0.75rem; background: #f8d7da; border-radius: 6px; white-space: pre-wrap;">${cancelReason}</div>
      </div>
      ` : ''}
      <div>
        <label style="font-size: 0.75rem; color: #6c757d; text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px;">생성일</label>
        <div style="font-size: 0.875rem; color: #6c757d; margin-top: 0.25rem;">${createdAt ? createdAt.substring(0, 19).replace('T', ' ') : '-'}</div>
      </div>
    </div>
  `;

  document.getElementById('bookingDetailContent').innerHTML = content;
  const modal = new bootstrap.Modal(document.getElementById('bookingDetailModal'));
  modal.show();
}

// 취소 모달 표시
function showCancelModal(event, bookingId, name, email) {
  event.stopPropagation();
  document.getElementById('cancelBookingId').value = bookingId;
  document.getElementById('cancelBookingName').textContent = name;
  document.getElementById('cancelBookingEmail').textContent = email;
  document.getElementById('cancelReason').value = '';

  const modal = new bootstrap.Modal(document.getElementById('cancelBookingModal'));
  modal.show();
}

// 링크 복사 함수
function copyLink(event, linkId) {
  const input = document.getElementById('link-url-' + linkId);
  input.select();
  input.setSelectionRange(0, 99999); // 모바일 지원

  navigator.clipboard.writeText(input.value).then(() => {
    // 복사 성공 알림
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '✅';
    setTimeout(() => {
      button.innerHTML = originalText;
    }, 2000);
  }).catch(err => {
    alert('복사 실패: ' + err);
  });
}

// 10분 후 자동 로그아웃
setTimeout(() => {
  alert("세션이 만료되어 로그아웃됩니다.");
  window.location.href = "{{ url_for('home') }}";
}, 600000);
</script>
{% endblock %}
