{% extends "base.html" %}

{% block title %}관리자 페이지 | 커피챗{% endblock %}

{% block content %}
<!-- 헤더 -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>🔧 관리자 대시보드</h2>
  <form method="post" action="{{ url_for('admin_logout') }}" onsubmit="return confirmLogout();">
    <button type="submit" class="btn btn-outline-danger btn-sm">🚪 로그아웃</button>
  </form>
</div>

<!-- 통계 대시보드 -->
<div class="row mb-4">
  <div class="col-md-3 col-6 mb-3">
    <div class="stat-card bg-warning-subtle">
      <div class="stat-icon">⏳</div>
      <div class="stat-label">대기 중</div>
      <div class="stat-value" id="pending-count">{{ bookings|selectattr('6', 'equalto', 'pending')|list|length + waitlist|selectattr('5', 'equalto', 'pending')|list|length }}</div>
    </div>
  </div>
  <div class="col-md-3 col-6 mb-3">
    <div class="stat-card bg-success-subtle">
      <div class="stat-icon">✅</div>
      <div class="stat-label">승인됨</div>
      <div class="stat-value">{{ bookings|selectattr('6', 'equalto', 'confirmed')|list|length + waitlist|selectattr('5', 'equalto', 'approved')|list|length }}</div>
    </div>
  </div>
  <div class="col-md-3 col-6 mb-3">
    <div class="stat-card bg-danger-subtle">
      <div class="stat-icon">❌</div>
      <div class="stat-label">거절됨</div>
      <div class="stat-value">{{ waitlist|selectattr('5', 'equalto', 'rejected')|list|length }}</div>
    </div>
  </div>
  <div class="col-md-3 col-6 mb-3">
    <div class="stat-card bg-info-subtle">
      <div class="stat-icon">🔗</div>
      <div class="stat-label">활성 링크</div>
      <div class="stat-value">{{ booking_links|selectattr('7', 'equalto', 1)|selectattr('6', 'equalto', 0)|list|length }}</div>
    </div>
  </div>
</div>

<!-- 탭 네비게이션 -->
<ul class="nav nav-tabs mb-3" id="adminTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button">
      📅 예약 목록 <span class="badge bg-warning">{{ bookings|selectattr('6', 'equalto', 'pending')|list|length }}</span>
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="links-tab" data-bs-toggle="tab" data-bs-target="#links" type="button">
      🔗 예약 링크
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="waitlist-tab" data-bs-toggle="tab" data-bs-target="#waitlist" type="button">
      📝 대기명단 <span class="badge bg-warning">{{ waitlist|selectattr('5', 'equalto', 'pending')|list|length }}</span>
    </button>
  </li>
</ul>

<!-- 탭 컨텐츠 -->
<div class="tab-content" id="adminTabContent">

  <!-- 예약 목록 탭 -->
  <div class="tab-pane fade show active" id="bookings" role="tabpanel">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <button class="btn btn-sm btn-outline-secondary" onclick="filterBookings('all')">전체</button>
        <button class="btn btn-sm btn-warning text-white" onclick="filterBookings('pending')">대기 중</button>
        <button class="btn btn-sm btn-success" onclick="filterBookings('confirmed')">승인됨</button>
      </div>
    </div>

    {% if bookings %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th style="width: 50px;">ID</th>
            <th>이름</th>
            <th>이메일</th>
            <th>전화</th>
            <th>선택 시간</th>
            <th>링크</th>
            <th style="width: 100px;">상태</th>
            <th style="width: 150px;">작업</th>
          </tr>
        </thead>
        <tbody id="bookings-tbody">
          {% for booking in bookings %}
          <tr data-status="{{ booking[6] }}">
            <td>{{ booking[0] }}</td>
            <td>{{ booking[1] }}</td>
            <td class="small">{{ booking[2] }}</td>
            <td class="small">{{ booking[3] }}</td>
            <td><strong class="text-primary">{{ booking[5] }}</strong></td>
            <td><span class="badge bg-info">{{ booking[9] }}</span></td>
            <td>
              {% if booking[6] == 'confirmed' %}
                <span class="badge bg-success">확정</span>
              {% elif booking[6] == 'cancelled' %}
                <span class="badge bg-danger">취소</span>
              {% else %}
                <span class="badge bg-warning">대기</span>
              {% endif %}
            </td>
            <td>
              {% if booking[6] == 'pending' %}
                <form method="post" class="d-inline">
                  <button type="submit" name="approve_booking_id" value="{{ booking[0] }}"
                          class="btn btn-success btn-sm"
                          onclick="return confirm('승인하시겠습니까?')">✓</button>
                </form>
              {% elif booking[6] == 'confirmed' and booking[7] %}
                <a href="{{ booking[7] }}" target="_blank" class="btn btn-primary btn-sm">Meet</a>
              {% endif %}
              <button class="btn btn-info btn-sm" onclick='showBookingDetail({{ booking[0] }}, {{ booking|tojson }})'>📋 상세</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted text-center py-4">예약 내역이 없습니다.</p>
    {% endif %}
  </div>

  <!-- 예약 링크 탭 -->
  <div class="tab-pane fade" id="links" role="tabpanel">
    <!-- 새 링크 생성 폼 -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">➕ 새 예약 링크 생성</h5>
        <form method="post" class="row g-3">
          <div class="col-md-9">
            <input type="text" name="link_name" class="form-control" placeholder="링크 이름 (예: 홍길동님 커피챗)" required>
          </div>
          <div class="col-md-3">
            <button type="submit" name="create_booking_link" value="1" class="btn btn-primary w-100">생성</button>
          </div>
        </form>
        <small class="text-muted">💡 링크는 미접속 시 7일, 첫 접속 후 30분 유효합니다.</small>
      </div>
    </div>

    <!-- 링크 목록 -->
    {% if booking_links %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th style="width: 50px;">ID</th>
            <th>이름</th>
            <th>URL</th>
            <th>생성일</th>
            <th style="width: 100px;">상태</th>
            <th style="width: 100px;">관리</th>
          </tr>
        </thead>
        <tbody>
          {% for link in booking_links %}
          <tr>
            <td>{{ link[0] }}</td>
            <td>{{ link[2] }}</td>
            <td>
              <code class="small">{{ host_url }}book/{{ link[1] }}</code>
              <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('{{ host_url }}book/{{ link[1] }}')">📋</button>
            </td>
            <td class="small">{{ link[3][:16] if link[3] }}</td>
            <td>
              {% if link[6] == 1 %}
                <span class="badge bg-success">완료</span>
              {% elif link[7] == 0 %}
                <span class="badge bg-secondary">비활성</span>
              {% elif link[5] and link[5] < now %}
                <span class="badge bg-danger">만료</span>
              {% elif link[4] %}
                <span class="badge bg-warning">진행중</span>
              {% else %}
                <span class="badge bg-info">미사용</span>
              {% endif %}
            </td>
            <td>
              <form method="post" class="d-inline">
                {% if link[7] == 1 and link[6] == 0 %}
                  <button type="submit" name="deactivate_link_id" value="{{ link[0] }}" class="btn btn-warning btn-sm">비활성</button>
                {% elif link[7] == 0 %}
                  <button type="submit" name="activate_link_id" value="{{ link[0] }}" class="btn btn-success btn-sm">활성화</button>
                {% endif %}
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted text-center py-4">생성된 링크가 없습니다.</p>
    {% endif %}
  </div>

  <!-- 대기명단 탭 -->
  <div class="tab-pane fade" id="waitlist" role="tabpanel">
    {% if waitlist %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th style="width: 50px;">ID</th>
            <th>이름</th>
            <th>이메일</th>
            <th>전화</th>
            <th>주제</th>
            <th style="width: 100px;">상태</th>
            <th style="width: 150px;">작업</th>
          </tr>
        </thead>
        <tbody>
          {% for w in waitlist %}
          <tr>
            <td>{{ w[0] }}</td>
            <td>{{ w[1] }}</td>
            <td class="small">{{ w[2] }}</td>
            <td class="small">{{ w[3] }}</td>
            <td class="small">{{ w[4][:50] }}...</td>
            <td>
              {% if w[5] == 'approved' %}
                <span class="badge bg-success">승인</span>
              {% elif w[5] == 'rejected' %}
                <span class="badge bg-danger">거절</span>
              {% else %}
                <span class="badge bg-warning">대기</span>
              {% endif %}
            </td>
            <td>
              {% if w[5] == 'pending' %}
                <form method="post" class="d-inline" onsubmit="return confirm('승인하시겠습니까?');">
                  <input type="hidden" name="approve_waitlist_id" value="{{ w[0] }}">
                  <button type="submit" class="btn btn-success btn-sm">✓</button>
                </form>
                <form method="post" class="d-inline" onsubmit="return confirm('거절하시겠습니까?');">
                  <input type="hidden" name="reject_waitlist_id" value="{{ w[0] }}">
                  <button type="submit" class="btn btn-warning btn-sm">✗</button>
                </form>
              {% endif %}
              <button class="btn btn-info btn-sm" onclick='showWaitlistDetail({{ w|tojson }})'>📋 상세</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted text-center py-4">대기 중인 사람이 없습니다.</p>
    {% endif %}
  </div>
</div>

<!-- 상세보기 모달 -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">상세 정보</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- 동적 컨텐츠 -->
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
  }

  .stat-card {
    padding: 1.5rem;
    border-radius: 16px;
    text-align: center;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    background: white;
  }

  .stat-card:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-lg);
  }

  .stat-card.bg-warning-subtle {
    background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%) !important;
    border-left: 4px solid #ffc107;
  }

  .stat-card.bg-success-subtle {
    background: linear-gradient(135deg, #e8f8f5 0%, #d1f2eb 100%) !important;
    border-left: 4px solid #28a745;
  }

  .stat-card.bg-danger-subtle {
    background: linear-gradient(135deg, #fef0f0 0%, #fdd 100%) !important;
    border-left: 4px solid #dc3545;
  }

  .stat-card.bg-info-subtle {
    background: linear-gradient(135deg, #e7f5ff 0%, #d0ebff 100%) !important;
    border-left: 4px solid #17a2b8;
  }

  .stat-icon {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
  }

  .stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .nav-tabs {
    border-bottom: 2px solid #e9ecef;
    margin-bottom: 2rem;
  }

  .nav-tabs .nav-link {
    color: #6c757d;
    border: none;
    border-radius: 12px 12px 0 0;
    padding: 1rem 1.5rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .nav-tabs .nav-link:hover {
    background: #f8f9fa;
    color: #495057;
  }

  .nav-tabs .nav-link.active {
    background: white;
    color: #667eea;
    font-weight: 700;
    border-bottom: 3px solid #667eea;
  }

  .table {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }

  .table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .table thead th {
    font-weight: 600;
    color: white !important;
    border: none;
    padding: 1rem;
  }

  .table tbody tr {
    transition: all 0.2s;
  }

  .table tbody tr:hover {
    background: #f8f9fa;
    transform: scale(1.01);
    box-shadow: var(--shadow-sm);
  }

  .card {
    border: none;
    border-radius: 16px;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s;
  }

  .card:hover {
    box-shadow: var(--shadow-md);
  }

  .badge {
    padding: 0.5rem 0.75rem;
    font-weight: 600;
    border-radius: 8px;
  }

  .btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--primary-gradient);
    border: none;
  }

  .btn-success {
    background: var(--success-gradient);
    border: none;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
  }
</style>

<script>
function confirmLogout() {
  return confirm("로그아웃하시겠습니까?");
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('링크가 복사되었습니다!');
  });
}

function filterBookings(status) {
  const rows = document.querySelectorAll('#bookings-tbody tr');
  rows.forEach(row => {
    if (status === 'all' || row.dataset.status === status) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

function showBookingDetail(id, booking) {
  document.getElementById('modalTitle').textContent = `예약 상세 #${id}`;
  document.getElementById('modalBody').innerHTML = `
    <dl class="row">
      <dt class="col-sm-3">이름</dt><dd class="col-sm-9">${booking[1]}</dd>
      <dt class="col-sm-3">이메일</dt><dd class="col-sm-9">${booking[2]}</dd>
      <dt class="col-sm-3">전화번호</dt><dd class="col-sm-9">${booking[3]}</dd>
      <dt class="col-sm-3">용건</dt><dd class="col-sm-9">${booking[4]}</dd>
      <dt class="col-sm-3">선택 시간</dt><dd class="col-sm-9"><strong>${booking[5]}</strong></dd>
      ${booking[7] ? `<dt class="col-sm-3">Meet 링크</dt><dd class="col-sm-9"><a href="${booking[7]}" target="_blank">${booking[7]}</a></dd>` : ''}
    </dl>
  `;
  new bootstrap.Modal(document.getElementById('detailModal')).show();
}

function showWaitlistDetail(w) {
  document.getElementById('modalTitle').textContent = `대기명단 #${w[0]}`;
  document.getElementById('modalBody').innerHTML = `
    <dl class="row">
      <dt class="col-sm-3">이름</dt><dd class="col-sm-9">${w[1]}</dd>
      <dt class="col-sm-3">이메일</dt><dd class="col-sm-9">${w[2]}</dd>
      <dt class="col-sm-3">전화번호</dt><dd class="col-sm-9">${w[3]}</dd>
      <dt class="col-sm-3">주제</dt><dd class="col-sm-9">${w[4]}</dd>
      <dt class="col-sm-3">등록일</dt><dd class="col-sm-9">${w[6]}</dd>
    </dl>
  `;
  new bootstrap.Modal(document.getElementById('detailModal')).show();
}

// 10분 후 자동 로그아웃
setTimeout(() => {
  alert("세션이 만료되어 로그아웃됩니다.");
  window.location.href = "{{ url_for('home') }}";
}, 600000);
</script>
{% endblock %}
