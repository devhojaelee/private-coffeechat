{% extends "base.html" %}

{% block title %}ê´€ë¦¬ì í˜ì´ì§€ | ì»¤í”¼ì±—{% endblock %}

{% block content %}
<!-- í—¤ë” -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h2>ğŸ”§ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h2>
  <form method="post" action="{{ url_for('admin_logout') }}" onsubmit="return confirmLogout();">
    <button type="submit" class="btn btn-outline-danger btn-sm">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
  </form>
</div>

<!-- í†µê³„ ëŒ€ì‹œë³´ë“œ -->
<div class="row mb-4">
  <div class="col-md-3 col-6 mb-3">
    <div class="stat-card bg-warning-subtle">
      <div class="stat-icon">â³</div>
      <div class="stat-label">ëŒ€ê¸° ì¤‘</div>
      <div class="stat-value" id="pending-count">{{ bookings|selectattr('6', 'equalto', 'pending')|list|length + waitlist|selectattr('5', 'equalto', 'pending')|list|length }}</div>
    </div>
  </div>
  <div class="col-md-3 col-6 mb-3">
    <div class="stat-card bg-success-subtle">
      <div class="stat-icon">âœ…</div>
      <div class="stat-label">ìŠ¹ì¸ë¨</div>
      <div class="stat-value">{{ bookings|selectattr('6', 'equalto', 'confirmed')|list|length + waitlist|selectattr('5', 'equalto', 'approved')|list|length }}</div>
    </div>
  </div>
  <div class="col-md-3 col-6 mb-3">
    <div class="stat-card bg-danger-subtle">
      <div class="stat-icon">âŒ</div>
      <div class="stat-label">ê±°ì ˆë¨</div>
      <div class="stat-value">{{ waitlist|selectattr('5', 'equalto', 'rejected')|list|length }}</div>
    </div>
  </div>
  <div class="col-md-3 col-6 mb-3">
    <div class="stat-card bg-info-subtle">
      <div class="stat-icon">ğŸ”—</div>
      <div class="stat-label">í™œì„± ë§í¬</div>
      <div class="stat-value">{{ booking_links|selectattr('7', 'equalto', 1)|selectattr('6', 'equalto', 0)|list|length }}</div>
    </div>
  </div>
</div>

<!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
<ul class="nav nav-tabs mb-3" id="adminTab" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button">
      ğŸ“… ì˜ˆì•½ ëª©ë¡ <span class="badge bg-warning">{{ bookings|selectattr('6', 'equalto', 'pending')|list|length }}</span>
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="links-tab" data-bs-toggle="tab" data-bs-target="#links" type="button">
      ğŸ”— ì˜ˆì•½ ë§í¬
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="waitlist-tab" data-bs-toggle="tab" data-bs-target="#waitlist" type="button">
      ğŸ“ ëŒ€ê¸°ëª…ë‹¨ <span class="badge bg-warning">{{ waitlist|selectattr('5', 'equalto', 'pending')|list|length }}</span>
    </button>
  </li>
</ul>

<!-- íƒ­ ì»¨í…ì¸  -->
<div class="tab-content" id="adminTabContent">

  <!-- ì˜ˆì•½ ëª©ë¡ íƒ­ -->
  <div class="tab-pane fade show active" id="bookings" role="tabpanel">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <button class="btn btn-sm btn-outline-secondary" onclick="filterBookings('all')">ì „ì²´</button>
        <button class="btn btn-sm btn-warning text-white" onclick="filterBookings('pending')">ëŒ€ê¸° ì¤‘</button>
        <button class="btn btn-sm btn-success" onclick="filterBookings('confirmed')">ìŠ¹ì¸ë¨</button>
      </div>
    </div>

    {% if bookings %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th style="width: 50px;">ID</th>
            <th>ì´ë¦„</th>
            <th>ì´ë©”ì¼</th>
            <th>ì „í™”</th>
            <th>ì„ íƒ ì‹œê°„</th>
            <th>ë§í¬</th>
            <th style="width: 100px;">ìƒíƒœ</th>
            <th style="width: 150px;">ì‘ì—…</th>
          </tr>
        </thead>
        <tbody id="bookings-tbody">
          {% for booking in bookings %}
          <tr data-status="{{ booking[6] }}">
            <td>{{ booking[0] }}</td>
            <td>{{ booking[1] }}</td>
            <td class="small">{{ booking[2] }}</td>
            <td class="small">{{ booking[3] }}</td>
            <td><strong class="text-primary">{{ booking[5] }}</strong></td>
            <td><span class="badge bg-info">{{ booking[9] }}</span></td>
            <td>
              {% if booking[6] == 'confirmed' %}
                <span class="badge bg-success">í™•ì •</span>
              {% elif booking[6] == 'cancelled' %}
                <span class="badge bg-danger">ì·¨ì†Œ</span>
              {% else %}
                <span class="badge bg-warning">ëŒ€ê¸°</span>
              {% endif %}
            </td>
            <td>
              {% if booking[6] == 'pending' %}
                <form method="post" class="d-inline">
                  <button type="submit" name="approve_booking_id" value="{{ booking[0] }}"
                          class="btn btn-success btn-sm"
                          onclick="return confirm('ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">âœ“</button>
                </form>
              {% elif booking[6] == 'confirmed' and booking[7] %}
                <a href="{{ booking[7] }}" target="_blank" class="btn btn-primary btn-sm">Meet</a>
              {% endif %}
              <button class="btn btn-info btn-sm" onclick='showBookingDetail({{ booking[0] }}, {{ booking|tojson }})'>ğŸ“‹ ìƒì„¸</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted text-center py-4">ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>

  <!-- ì˜ˆì•½ ë§í¬ íƒ­ -->
  <div class="tab-pane fade" id="links" role="tabpanel">
    <!-- ìƒˆ ë§í¬ ìƒì„± í¼ -->
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">â• ìƒˆ ì˜ˆì•½ ë§í¬ ìƒì„±</h5>
        <form method="post" class="row g-3">
          <div class="col-md-9">
            <input type="text" name="link_name" class="form-control" placeholder="ë§í¬ ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™ë‹˜ ì»¤í”¼ì±—)" required>
          </div>
          <div class="col-md-3">
            <button type="submit" name="create_booking_link" value="1" class="btn btn-primary w-100">ìƒì„±</button>
          </div>
        </form>
        <small class="text-muted">ğŸ’¡ ë§í¬ëŠ” ë¯¸ì ‘ì† ì‹œ 7ì¼, ì²« ì ‘ì† í›„ 30ë¶„ ìœ íš¨í•©ë‹ˆë‹¤.</small>
      </div>
    </div>

    <!-- ë§í¬ ëª©ë¡ -->
    {% if booking_links %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th style="width: 50px;">ID</th>
            <th>ì´ë¦„</th>
            <th>URL</th>
            <th>ìƒì„±ì¼</th>
            <th style="width: 100px;">ìƒíƒœ</th>
            <th style="width: 100px;">ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody>
          {% for link in booking_links %}
          <tr>
            <td>{{ link[0] }}</td>
            <td>{{ link[2] }}</td>
            <td>
              <code class="small">{{ host_url }}book/{{ link[1] }}</code>
              <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('{{ host_url }}book/{{ link[1] }}')">ğŸ“‹</button>
            </td>
            <td class="small">{{ link[3][:16] if link[3] }}</td>
            <td>
              {% if link[6] == 1 %}
                <span class="badge bg-success">ì™„ë£Œ</span>
              {% elif link[7] == 0 %}
                <span class="badge bg-secondary">ë¹„í™œì„±</span>
              {% elif link[5] and link[5] < now %}
                <span class="badge bg-danger">ë§Œë£Œ</span>
              {% elif link[4] %}
                <span class="badge bg-warning">ì§„í–‰ì¤‘</span>
              {% else %}
                <span class="badge bg-info">ë¯¸ì‚¬ìš©</span>
              {% endif %}
            </td>
            <td>
              <form method="post" class="d-inline">
                {% if link[7] == 1 and link[6] == 0 %}
                  <button type="submit" name="deactivate_link_id" value="{{ link[0] }}" class="btn btn-warning btn-sm">ë¹„í™œì„±</button>
                {% elif link[7] == 0 %}
                  <button type="submit" name="activate_link_id" value="{{ link[0] }}" class="btn btn-success btn-sm">í™œì„±í™”</button>
                {% endif %}
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted text-center py-4">ìƒì„±ëœ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>

  <!-- ëŒ€ê¸°ëª…ë‹¨ íƒ­ -->
  <div class="tab-pane fade" id="waitlist" role="tabpanel">
    {% if waitlist %}
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th style="width: 50px;">ID</th>
            <th>ì´ë¦„</th>
            <th>ì´ë©”ì¼</th>
            <th>ì „í™”</th>
            <th>ì£¼ì œ</th>
            <th style="width: 100px;">ìƒíƒœ</th>
            <th style="width: 150px;">ì‘ì—…</th>
          </tr>
        </thead>
        <tbody>
          {% for w in waitlist %}
          <tr>
            <td>{{ w[0] }}</td>
            <td>{{ w[1] }}</td>
            <td class="small">{{ w[2] }}</td>
            <td class="small">{{ w[3] }}</td>
            <td class="small">{{ w[4][:50] }}...</td>
            <td>
              {% if w[5] == 'approved' %}
                <span class="badge bg-success">ìŠ¹ì¸</span>
              {% elif w[5] == 'rejected' %}
                <span class="badge bg-danger">ê±°ì ˆ</span>
              {% else %}
                <span class="badge bg-warning">ëŒ€ê¸°</span>
              {% endif %}
            </td>
            <td>
              {% if w[5] == 'pending' %}
                <form method="post" class="d-inline" onsubmit="return confirm('ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                  <input type="hidden" name="approve_waitlist_id" value="{{ w[0] }}">
                  <button type="submit" class="btn btn-success btn-sm">âœ“</button>
                </form>
                <form method="post" class="d-inline" onsubmit="return confirm('ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                  <input type="hidden" name="reject_waitlist_id" value="{{ w[0] }}">
                  <button type="submit" class="btn btn-warning btn-sm">âœ—</button>
                </form>
              {% endif %}
              <button class="btn btn-info btn-sm" onclick='showWaitlistDetail({{ w|tojson }})'>ğŸ“‹ ìƒì„¸</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="text-muted text-center py-4">ëŒ€ê¸° ì¤‘ì¸ ì‚¬ëŒì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>
</div>

<!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">ìƒì„¸ ì •ë³´</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- ë™ì  ì»¨í…ì¸  -->
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
    --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
  }

  .stat-card {
    padding: 1.5rem;
    border-radius: 16px;
    text-align: center;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: none;
    background: white;
  }

  .stat-card:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-lg);
  }

  .stat-card.bg-warning-subtle {
    background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%) !important;
    border-left: 4px solid #ffc107;
  }

  .stat-card.bg-success-subtle {
    background: linear-gradient(135deg, #e8f8f5 0%, #d1f2eb 100%) !important;
    border-left: 4px solid #28a745;
  }

  .stat-card.bg-danger-subtle {
    background: linear-gradient(135deg, #fef0f0 0%, #fdd 100%) !important;
    border-left: 4px solid #dc3545;
  }

  .stat-card.bg-info-subtle {
    background: linear-gradient(135deg, #e7f5ff 0%, #d0ebff 100%) !important;
    border-left: 4px solid #17a2b8;
  }

  .stat-icon {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
  }

  .stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 0.5rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .nav-tabs {
    border-bottom: 2px solid #e9ecef;
    margin-bottom: 2rem;
  }

  .nav-tabs .nav-link {
    color: #6c757d;
    border: none;
    border-radius: 12px 12px 0 0;
    padding: 1rem 1.5rem;
    font-weight: 500;
    transition: all 0.2s;
  }

  .nav-tabs .nav-link:hover {
    background: #f8f9fa;
    color: #495057;
  }

  .nav-tabs .nav-link.active {
    background: white;
    color: #667eea;
    font-weight: 700;
    border-bottom: 3px solid #667eea;
  }

  .table {
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-sm);
  }

  .table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .table thead th {
    font-weight: 600;
    color: white !important;
    border: none;
    padding: 1rem;
  }

  .table tbody tr {
    transition: all 0.2s;
  }

  .table tbody tr:hover {
    background: #f8f9fa;
    transform: scale(1.01);
    box-shadow: var(--shadow-sm);
  }

  .card {
    border: none;
    border-radius: 16px;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s;
  }

  .card:hover {
    box-shadow: var(--shadow-md);
  }

  .badge {
    padding: 0.5rem 0.75rem;
    font-weight: 600;
    border-radius: 8px;
  }

  .btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--primary-gradient);
    border: none;
  }

  .btn-success {
    background: var(--success-gradient);
    border: none;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
  }
</style>

<script>
function confirmLogout() {
  return confirm("ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
  });
}

function filterBookings(status) {
  const rows = document.querySelectorAll('#bookings-tbody tr');
  rows.forEach(row => {
    if (status === 'all' || row.dataset.status === status) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}

function showBookingDetail(id, booking) {
  document.getElementById('modalTitle').textContent = `ì˜ˆì•½ ìƒì„¸ #${id}`;
  document.getElementById('modalBody').innerHTML = `
    <dl class="row">
      <dt class="col-sm-3">ì´ë¦„</dt><dd class="col-sm-9">${booking[1]}</dd>
      <dt class="col-sm-3">ì´ë©”ì¼</dt><dd class="col-sm-9">${booking[2]}</dd>
      <dt class="col-sm-3">ì „í™”ë²ˆí˜¸</dt><dd class="col-sm-9">${booking[3]}</dd>
      <dt class="col-sm-3">ìš©ê±´</dt><dd class="col-sm-9">${booking[4]}</dd>
      <dt class="col-sm-3">ì„ íƒ ì‹œê°„</dt><dd class="col-sm-9"><strong>${booking[5]}</strong></dd>
      ${booking[7] ? `<dt class="col-sm-3">Meet ë§í¬</dt><dd class="col-sm-9"><a href="${booking[7]}" target="_blank">${booking[7]}</a></dd>` : ''}
    </dl>
  `;
  new bootstrap.Modal(document.getElementById('detailModal')).show();
}

function showWaitlistDetail(w) {
  document.getElementById('modalTitle').textContent = `ëŒ€ê¸°ëª…ë‹¨ #${w[0]}`;
  document.getElementById('modalBody').innerHTML = `
    <dl class="row">
      <dt class="col-sm-3">ì´ë¦„</dt><dd class="col-sm-9">${w[1]}</dd>
      <dt class="col-sm-3">ì´ë©”ì¼</dt><dd class="col-sm-9">${w[2]}</dd>
      <dt class="col-sm-3">ì „í™”ë²ˆí˜¸</dt><dd class="col-sm-9">${w[3]}</dd>
      <dt class="col-sm-3">ì£¼ì œ</dt><dd class="col-sm-9">${w[4]}</dd>
      <dt class="col-sm-3">ë“±ë¡ì¼</dt><dd class="col-sm-9">${w[6]}</dd>
    </dl>
  `;
  new bootstrap.Modal(document.getElementById('detailModal')).show();
}

// 10ë¶„ í›„ ìë™ ë¡œê·¸ì•„ì›ƒ
setTimeout(() => {
  alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì–´ ë¡œê·¸ì•„ì›ƒë©ë‹ˆë‹¤.");
  window.location.href = "{{ url_for('home') }}";
}, 600000);
</script>
{% endblock %}
