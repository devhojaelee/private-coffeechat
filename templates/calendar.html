<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì˜ˆì•½ ê°€ëŠ¥ ì¼ì •</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/progress.css">
<style>
  body {
    background-color: #f3ede7;
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    color: #4a3f35;
  }

  .card {
    width: 100%;
    max-width: 1100px;
    padding: 2rem;
    border-radius: 1.5rem;
    background-color: #fffdfc;
    box-shadow: 0 0.5rem 1.2rem rgba(0, 0, 0, 0.05);
    border: none;
  }

  .modal-content {
    border-radius: 1rem;
    background-color: #fffdfc;
  }

/* === PC ì „ìš© (ê¸°ë³¸) === */
.fc .fc-button {
  font-size: 0.85rem !important;
  padding: 0.45rem 1rem !important;
  border-radius: 6px !important;
  font-weight: 500 !important;
  background-color: #f3ede7 !important;
  border: 1px solid #d2bfae !important;
  color: #6b4c3b !important;
  transition: all 0.2s ease-in-out;
}

.fc .fc-button.active-focus {
  background-color: #6b4c3b !important;
  border-color: #6b4c3b !important;
  color: #fffdfc !important;
}
/* a íƒœê·¸ ìš”ì¼ í…ìŠ¤íŠ¸ ì´ˆê¸°í™” ë° ì»¤í”¼ì±— ìŠ¤íƒ€ì¼ */
.fc .fc-col-header-cell-cushion {
  color: #4a3f35 !important;       /* ì»¤í”¼ì±— ë‹¤í¬ ë¸Œë¼ìš´ */
  text-decoration: none !important;
  font-weight: 500;
  font-size: 0.9rem;
  display: inline-block;
  width: 100%;
  padding: 0.6rem 0;
}

/* ì¼ìš”ì¼ ê°•ì¡° */
.fc th[data-date$=\"0\"] .fc-col-header-cell-cushion {
  color: #a56a5c !important;
  font-weight: 600;
}

/* í† ìš”ì¼ ê°•ì¡° */
.fc th[data-date$=\"6\"] .fc-col-header-cell-cushion {
  color: #7f6657 !important;
  font-weight: 600;
}

.fc .fc-button .fc-icon {
  font-size: 1rem !important;
}

/* í—¤ë” íƒ€ì´í‹€ */
h2.fc-toolbar-title {
  font-size: 1rem !important;
  font-weight: 600 !important;
  color: #4a3f35;
  margin: 0;
}

/* ë‚ ì§œ ìˆ«ì ìŠ¤íƒ€ì¼ */
.fc .fc-daygrid-day-number {
  all: unset;  /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì™„ì „íˆ ì œê±° */
  display: inline-block;
  font-size: 0.85rem;
  color: #4a3f35;
  font-weight: 500;
  padding: 0.2rem 0.4rem;
  text-align: right;
  width: 100%;
  cursor: pointer;
}

.calendar-wrapper {
  position: relative;
}

.spinner-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(255, 255, 255, 0.7);
  display: none;
  z-index: 10;

  /* í•µì‹¬ Flex ì„¤ì • */
  display: flex;
  align-items: center;       /* ì„¸ë¡œ ê°€ìš´ë° */
  justify-content: center;   /* ê°€ë¡œ ê°€ìš´ë° */
  flex-direction: column;    /* í…ìŠ¤íŠ¸ë¥¼ ì•„ë˜ë¡œ */
  text-align: center;
}



/* ë°˜ì‘í˜• ëŒ€ì‘ */
@media (max-width: 576px) {
  .fc .fc-col-header-cell-cushion {
    font-size: 0.75rem;
    padding: 0.4rem 0;
  }
  
  .fc .fc-daygrid-day-number {
  all: unset;  /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì™„ì „íˆ ì œê±° */
  display: inline-block;
  font-size: 0.7rem;
  color: #4a3f35;
  font-weight: 500;
  padding: 0.2rem 0.4rem;
  text-align: right;
  width: 100%;
  cursor: pointer;
}
}

</style>

</head>
<body>
  <div class="card">
    <div class="progress-stepper" data-current-step="3" role="navigation" aria-label="ì˜ˆì•½ ì§„í–‰ ë‹¨ê³„">
      <div class="progress-step completed">
        <div class="step-circle">1</div>
        <div class="step-label">ì •ë³´ì…ë ¥</div>
      </div>
      <span class="step-arrow" aria-hidden="true">â†’</span>
      <div class="progress-step completed">
        <div class="step-circle">2</div>
        <div class="step-label">ì´ë©”ì¼ì¸ì¦</div>
      </div>
      <span class="step-arrow" aria-hidden="true">â†’</span>
      <div class="progress-step active">
        <div class="step-circle" aria-current="step">3</div>
        <div class="step-label">ì‹œê°„ì„ íƒ</div>
      </div>
      <span class="step-arrow" aria-hidden="true">â†’</span>
      <div class="progress-step">
        <div class="step-circle">4</div>
        <div class="step-label">ì™„ë£Œ</div>
      </div>
    </div>

    <h3 class="text-center mb-4">ğŸ“… ì˜ˆì•½ ê°€ëŠ¥ ì¼ì •</h3>
      <!-- ì¹´ë“œ ì•„ë˜ì— ì¶”ê°€ -->
  <div class="calendar-wrapper position-relative">
    <div id="calendar"></div>
    <div id="loadingSpinner" class="spinner-overlay text-center">
      <div class="spinner-border text-secondary" role="status">
        <span class="visually-hidden">ë¡œë”© ì¤‘...</span>
      </div>
      <div class="mt-2">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>
  </div>
    <div id="calendar"></div>
  </div>



  <!-- ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ ì„ íƒ ëª¨ë‹¬ -->
  <div class="modal fade" id="slotModal" tabindex="-1" aria-labelledby="slotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <form method="POST" action="/reservation">
          <div class="modal-header">
            <h5 class="modal-title" id="slotModalLabel">ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ ì„ íƒ</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ë‹«ê¸°"></button>
          </div>
          <div class="modal-body">
            <ul id="timeslot-list" class="list-group small"></ul>
          </div>
          <input type="hidden" name="selected_slots" id="selected_slots_input">
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary" id="nextBtn" disabled>ë‹¤ìŒ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ìŠ¤í¬ë¦½íŠ¸ -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="/static/js/progress.js"></script>
  <script>
    const allSlots = [];
    let selectedSlots = [];

    function formatTime(date) {
      const hour = date.getHours();
      const minute = date.getMinutes();
      const ampm = hour < 12 ? "ì˜¤ì „" : "ì˜¤í›„";
      const hour12 = hour % 12 === 0 ? 12 : hour % 12;
      const minPad = String(minute).padStart(2, '0');
      return `${ampm} ${hour12}:${minPad}`;
    }
    <!-- í•œêµ­ ì‹œê°„ìœ¼ë¡œ ë³´ì • +9ì‹œê°„ -->
    function formatISO(dt) {
  const tzOffset = dt.getTimezoneOffset() * 60000;
  const localISOTime = new Date(dt - tzOffset).toISOString().slice(0, 19);
  return localISOTime;
}

    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        timeZone: 'Asia/Seoul',
        height: "auto",
        headerToolbar: {
          left: 'prev,today,next',
          center: 'title',
          right: ''
        },
        events: function(info, successCallback, failureCallback) {
  const middleTime = (info.start.getTime() + info.end.getTime()) / 2;
  const middleDate = new Date(middleTime);
  const year = middleDate.getFullYear();
  const month = middleDate.getMonth() + 1;

  // ğŸ’¡ ë¡œë”© ì‹œì‘
  document.getElementById('loadingSpinner').style.display = 'block';

  fetch(`/api/available-slots?year=${year}&month=${month}&view=month`)
    .then(response => response.json())
    .then(data => {
  document.getElementById('loadingSpinner').style.display = 'none';

  const grouped = data;  // ì´ì œ groupedëŠ” ì´ë¯¸ ë‚ ì§œë³„ë¡œ ì •ë¦¬ëœ í˜•íƒœì„
  const isMobile = window.innerWidth <= 576;
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const summarized = Object.keys(grouped).map(date => {
    const dayDate = new Date(date);
    const slotList = Array.isArray(grouped[date]) ? grouped[date] : [];

    const filtered = slotList.filter(slot => {
      const hour = new Date(slot.start).getHours();
      return hour >= 10 && hour < 18;
    });

    const count = filtered.length;

    let icon = "ğŸŸ¢", label = "ì˜ˆì•½ ê°€ëŠ¥";
    if (dayDate < today) {
      icon = "âš«ï¸";
      label = "ì§€ë‚œ ë‚ ì§œ";
    } else if (count === 0) {
      icon = "âš«ï¸";
      label = "ì˜ˆì•½ ë¶ˆê°€";
    } else if (count <= 2) {
      icon = "ğŸ”´";
      label = "ê±°ì˜ ì—†ìŒ";
    } else if (count <= 6) {
      icon = "ğŸŸ¡";
      label = "ì¼ë¶€ ê°€ëŠ¥";
    } else if (count > 16) {
      icon = "âš«ï¸";
      label = "ì˜ˆì•½ ë¶ˆê°€";
    }

    // ì „ì²´ ìŠ¬ë¡¯ë„ ì €ì¥ (ëª¨ë‹¬ìš©)
    for (const s of slotList) allSlots.push(s);

    return {
      title: isMobile ? `${icon}` : `${icon} ${label}`,
      start: date,
      allDay: true,
      display: 'block',
      extendedProps: { tooltip: label, date: date }
    };
  });

  successCallback(summarized);
})

    .catch(err => {
      console.error(err);
      failureCallback(err);
      // ğŸ’¡ ì—ëŸ¬ ì‹œì—ë„ ë¡œë”© ì¢…ë£Œ
      document.getElementById('loadingSpinner').style.display = 'none';
    });
}
,
        eventClick: function(info) {
          const dateStr = info.event.extendedProps.date;
          const selectedDate = new Date(dateStr);
          const now = new Date();
          now.setHours(0, 0, 0, 0);

          if (selectedDate < now) {
            alert("ì´ë¯¸ ì§€ë‚œ ë‚ ì§œëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          const list = document.getElementById("timeslot-list");
          list.innerHTML = "";
          selectedSlots = [];
          document.getElementById("selected_slots_input").value = "";
          document.getElementById("nextBtn").disabled = true;

          const baseDate = new Date(`${dateStr}T10:00:00`);
          const slotsPerDay = [];

          for (let i = 0; i < 16; i++) {
            const slotStart = new Date(baseDate.getTime() + i * 30 * 60 * 1000);
            const slotEnd = new Date(slotStart.getTime() + 30 * 60 * 1000);
            const found = allSlots.find(slot => new Date(slot.start).getTime() === slotStart.getTime());
            slotsPerDay.push({ start: slotStart, end: slotEnd, available: !!found });
          }

          for (const slot of slotsPerDay) {
            const li = document.createElement("li");
            const iso = formatISO(slot.start);
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.dataset.slot = iso;

            const timeText = `${formatTime(slot.start)} ~ ${formatTime(slot.end)}`;
            const badge = slot.available
              ? '<span class="badge bg-success">ì˜ˆì•½ ê°€ëŠ¥</span>'
              : '<span class="badge bg-secondary">ì˜ˆì•½ ë¶ˆê°€</span>';
            li.innerHTML = `<span>${timeText}</span>${badge}`;

            if (slot.available) {
              li.style.cursor = "pointer";
              li.addEventListener("click", () => {
                if (selectedSlots.includes(iso)) {
                  selectedSlots = selectedSlots.filter(s => s !== iso);
                  li.classList.remove("active");
                } else {
                  if (selectedSlots.length === 0 || isConsecutive(selectedSlots[selectedSlots.length - 1], iso)) {
                    selectedSlots.push(iso);
                    selectedSlots.sort();
                    li.classList.add("active");
                  } else {
                    alert("ì—°ì†ëœ 30ë¶„ ë‹¨ìœ„ë¡œë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                  }
                }
                document.getElementById("selected_slots_input").value = selectedSlots.join(",");
                document.getElementById("nextBtn").disabled = selectedSlots.length === 0;
              });
            }

            list.appendChild(li);
          }

          const modal = new bootstrap.Modal(document.getElementById('slotModal'));
          modal.show();
        }
      });

      calendar.render();
    });

    function isConsecutive(lastISO, nextISO) {
      const last = new Date(lastISO);
      const next = new Date(nextISO);
      return Math.abs(next - last) === 30 * 60 * 1000;
    }
  </script>
</body>
</html>
